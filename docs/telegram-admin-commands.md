# Telegram админ-команды

Документ фиксирует черновой UX для административных команд бота. Он описывает, что видит оператор при вводе команд и какие действия выполняются в ответ.

## `/admin`

Команда без аргументов отправляет в чат справку со списком поддерживаемых операций:

```
Доступные команды администратора:
- /admin status — проверить, есть ли у вас доступ администратора. Ответ: admin-ok или forbidden.
- /broadcast — мгновенная рассылка по минимальной модели (бот запросит текст и отправит сразу).
- /export [from] [to] — выгрузить историю диалогов в CSV. Даты необязательные, формат YYYY-MM-DD.
```

Дополнительно поддерживаются подкоманды:

* `/admin status` — бот отвечает `admin-ok` или `forbidden` в зависимости от whitelisting.
* `/admin export …` — эквивалент прямому вызову `/export`.
* `/admin broadcast` — алиас к `/broadcast` для операторов, которым так удобнее запускать сценарий.

Если Telegram возвращает ошибки `400` или `403` при ответе на `/admin`, бот логирует событие с полями `status` и `description`, инвалидирует кеш whitelist-а и сохраняет запись `admin-error:<userId>` в KV. Эти данные отображаются в диагностическом роуте.

## `GET /admin/access`

HTTP-маршрут диагностики whitelisting доступен по админ-токену. Возвращает JSON со структурой:

```
{
  "whitelist": ["123", "456"],
  "health": [
    { "userId": "123", "status": "ok" },
    { "userId": "456", "status": 403, "lastError": "blocked" }
  ],
  "kvRaw": "{\"whitelist\":[\"123\",\"456\"]}",
  "adminErrors": {
    "456": { "status": 403, "description": "Forbidden: bot was blocked by the user", "at": "2024-03-01T00:00:00.000Z" }
  }
}
```

- `whitelist` — нормализованный список ID из `ADMIN_TG_IDS`.
- `kvRaw` — исходное значение ключа `whitelist` в KV.
- `health` — попытка отправить безопасное сообщение каждому whitelisted ID. `status` равен `"ok"` при успехе, HTTP-статусу `TelegramApiError` при сбое или `"skipped"`, если порт сообщений недоступен. `lastError` содержит текст последней ошибки.
- `adminErrors` — последняя зафиксированная ошибка отправки `/admin`-сообщений для каждого `userId`. Запись появляется, если Telegram вернул `400/403` и содержит `status`, `description` и метку времени `at` (ISO 8601).

Маршрут помогает проверять whitelisting и доступность Telegram-адаптера без реальных рассылок.

## `/export`

Синтаксис: `/export [from] [to]`, где аргументы — даты в формате `YYYY-MM-DD`. Без аргументов выгружается последняя история диалогов. После обработки команда отправляет CSV-файл через Telegram API и логирует попытку в KV.

## `/broadcast`

Команда работает только для whitelisted администраторов и не использует HTTP-роуты или очередь сообщений:

1. Отправьте `/broadcast` (или `/admin broadcast`) боту в личном чате.
2. Бот ответит подсказкой «Введите текст рассылки».
3. Следующее сообщение (непустое, ≤4096 символов) немедленно доставляется всем получателям минимальной модели рассылок.
4. Бот подтверждает выполнение и сообщает итог (например, количество чатов).

Если пользователь не в whitelist, команда возвращает `forbidden`, и рассылка не выполняется.

## Поведение для неавторизованных пользователей

Все перечисленные команды проверяют `AdminAccess`. Если пользователь не whitelisted, обработчик возвращает `undefined`, и сообщение попадает в стандартный пайплайн бота без дополнительных ответов.
