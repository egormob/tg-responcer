# Telegram админ-команды

Документ фиксирует черновой UX для административных команд бота. Он описывает, что видит оператор при вводе команд и какие действия выполняются в ответ.

## `/admin`

Команда без аргументов отправляет в чат справку со списком поддерживаемых операций:

```
Доступные команды администратора:
- /admin status — проверить, есть ли у вас доступ администратора. Ответ: admin-ok или forbidden.
- /broadcast help — подсказка по рассылкам. Используйте /broadcast send для подготовки отправки.
- /export [from] [to] — выгрузить историю диалогов в CSV. Даты необязательные, формат YYYY-MM-DD.
```

Дополнительно поддерживаются подкоманды:

* `/admin status` — бот отвечает `admin-ok` или `forbidden` в зависимости от whitelisting.
* `/admin export …` — эквивалент прямому вызову `/export`.
* `/admin broadcast …` — проксирует команды из пространства имён `/broadcast` (см. ниже).

## `/export`

Синтаксис: `/export [from] [to]`, где аргументы — даты в формате `YYYY-MM-DD`. Без аргументов выгружается последняя история диалогов. После обработки команда отправляет CSV-файл через Telegram API и логирует попытку в KV.

## `/broadcast`

Команда работает поверх того же whitelisting, что и HTTP-роут `/admin/broadcast`. Поддерживаемые режимы:

* `/broadcast help` — бот отправляет инструкцию по параметрам рассылок и напоминает про HTTP POST `/admin/broadcast`.
* `/broadcast preview <текст>` — текст отправляется только инициатору для проверки отображения.
* `/broadcast send [--chat=<id>] [--user=<id>] [--lang=<code>] <текст>` — Telegram валидирует фильтры и текст, после чего отвечает структурой payload, который нужно передать в HTTP POST `/admin/broadcast` вместе с заголовками `X-Admin-Token` и `X-Admin-Actor`.
* `/broadcast edit <jobId> <текст>` — редактирует сообщение активной рассылки через Telegram API, если с момента отправки прошло не более 48 часов.
* `/broadcast cancel <jobId>` — удаляет сообщение рассылки, соблюдая 48-часовое ограничение Telegram на редактирование и удаление.

Если фильтры не указаны, команда вернёт ошибку и не продолжит выполнение. Команда `/admin broadcast …` доступна как алиас для этих сценариев.

## Поведение для неавторизованных пользователей

Все перечисленные команды проверяют `AdminAccess`. Если пользователь не whitelisted, обработчик возвращает `undefined`, и сообщение попадает в стандартный пайплайн бота без дополнительных ответов.
