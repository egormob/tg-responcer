# –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã

–í—Å–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ä—É—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º. –î–ª—è –¥–æ—Å—Ç—É–ø–∞
–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `x-admin-token` –∏–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
`token` —Å –≤–∞–ª–∏–¥–Ω—ã–º –∞–¥–º–∏–Ω-—Ç–æ–∫–µ–Ω–æ–º.

## –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

1. `GET /admin/diag?q=telegram.getMe` ‚Äî —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ Bot API –æ—Ç–≤–µ—á–∞–µ—Ç
   –∏ —Ç–æ–∫–µ–Ω –Ω–µ –ø—Ä–æ—Ç—É—Ö. –í –æ—Ç–≤–µ—Ç–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ñ–ª–∞–≥–∏ `ok`, HTTP-—Å—Ç–∞—Ç—É—Å
   Telegram –∏ `description`; —Å–∞–º —Ç–æ–∫–µ–Ω –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è.
2. `GET /admin/selftest` ‚Äî –ø—Ä–æ–≥–æ–Ω—è–µ–º end-to-end self-test: OpenAI, Telegram
   –∏ D1/KV (–ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏). –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `chatId`, –≤–æ—Ä–∫–µ—Ä –≤–æ–∑—å–º—ë—Ç
   –ø–µ—Ä–≤—ã–π ID –∏–∑ whitelist –≤ `ADMIN_TG_IDS` –∏ –≤–µ—Ä–Ω—ë—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π ID –≤ —Ç–µ–ª–µ
   –æ—Ç–≤–µ—Ç–∞.
3. `GET /admin/diag?q=bindings` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º KV/D1 –∏ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ
   –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –ø—Ä–æ–∫–∏–Ω—É—Ç—ã (–ø–æ–ª–µ `secrets.*.present`).

## `GET /admin/selftest`

–ü—Ä–æ–≥–æ–Ω—è–µ—Ç self-test –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (OpenAI, Telegram,
—Ö—Ä–∞–Ω–∏–ª–∏—â–µ). –†—É—á–∫–∞ –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—Ç `200 OK`, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω—ã ‚Äî
—Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø–æ–ª—è—Ö –æ—Ç–≤–µ—Ç–∞.

### –ü–æ–ª—è –æ—Ç–≤–µ—Ç–∞

- `openAiOk` ‚Äî `true`, –µ—Å–ª–∏ OpenAI –≤–µ—Ä–Ω—É–ª –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä–∫–µ—Ä
  `[[tg-responcer:selftest:openai-ok]]` –∏ –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –∏–∑ `output_text`.
- `openAiReason` ‚Äî –∫–æ–¥ –ø—Ä–∏—á–∏–Ω—ã (`missing_diagnostic_marker`,
  `marker_in_fallback_output`, `request_failed`, `noop_adapter_response`).
- `openAiLatencyMs`, `openAiUsedOutputText`, `openAiSample`,
  `openAiResponseId` ‚Äî —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è –∏ —Å–Ω–∏–ø–ø–µ—Ç –æ—Ç–≤–µ—Ç–∞ (–º–∞—Ä–∫–µ—Ä –≤—ã—Ä–µ–∑–∞–µ—Ç—Å—è).
- `openAiEndpointId`, `openAiBaseUrl` ‚Äî –∫–∞–∫–∞—è –Ω–æ–¥–∞ –¥–≤—É—Ö—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤–æ–π
  –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã OpenAI-–∞–¥–∞–ø—Ç–µ—Ä–∞ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π. –ó–Ω–∞—á–µ–Ω–∏—è –±–µ—Ä—É—Ç—Å—è –∏–∑
  –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞: –Ω–∞–ø—Ä–∏–º–µ—Ä, `endpoint_1` + `https://api.openai.com/v1/responses`
  –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ –∏ –¥—Ä—É–≥–æ–π base URL –¥–ª—è –±—ç–∫–∞–ø–∞.
- `telegramOk` ‚Äî `true`, –µ—Å–ª–∏ Bot API –ø—Ä–∏–Ω—è–ª `sendTyping` –∏ `sendMessage`.
- `telegramReason` ‚Äî `chat_id_missing` (query-–ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –∏
  whitelist –ø—É—Å—Ç), –ª–∏–±–æ `send_failed` (Bot API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É).
- `telegramStatus`, `telegramDescription`, `telegramChatId`,
  `telegramChatIdSource` ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–∑–æ–≤–∞.
- `errors` ‚Äî –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ –æ—à–∏–±–æ–∫ (`openai: ‚Ä¶`, `telegram: ‚Ä¶`).
- `lastWebhookSnapshot` ‚Äî —Å–Ω–∏–º–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–µ–±—Ö—É–∫–∞/–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫.

–î–ª—è `q=utm` –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è `test`, `ok`, `saveOk`, `readOk`,
`utmDegraded`; —Ä—É—á–∫–∞ —Ç–∞–∫–∂–µ –æ—Ç–≤–µ—á–∞–µ—Ç `200 OK` –¥–∞–∂–µ –ø—Ä–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
(`ok:false`, `errors:[‚Ä¶]`).

### –õ–æ–≥–∏ Cloudflare

Self-test –ø–∏—à–µ—Ç –¥–≤–∞ —á–∏—Ç–∞–µ–º—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è:

```
[admin:selftest][openai] {
  scope,
  check,
  ok,
  endpointId?,
  baseUrl?,
  reason?,
  responseId?,
  latencyMs?,
  sample?
}
[admin:selftest][telegram] {
  scope,
  check,
  ok,
  route,
  chatIdRawType,
  chatIdRawHash,
  chatIdNormalizedHash,
  status?,
  reason?
}
```

–í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç `chatIdSource`, `description`,
`latencyMs` –∏ —Å–æ–≤–ø–∞–¥–∞—é—â–∏–µ —Ö—ç—à–∏ `chatIdRawHash` / `chatIdNormalizedHash`,
—á—Ç–æ–±—ã –ª–µ–≥–∫–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è ID.

–ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –ø–æ–º–æ–≥–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º –ø–æ–Ω–∏–º–∞—Ç—å, –∫–∞–∫–æ–π –±–∞–∑–æ–≤—ã–π URL
–¥–≤—É—Ö—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ OpenAI –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –∏–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É: –ø—Ä–∏
—Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ failover –≤ –ª–æ–≥ –∏ —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ø–∞–¥–∞—é—Ç `openAiEndpointId` –∏
`openAiBaseUrl`, –ø–æ—ç—Ç–æ–º—É —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, —á—Ç–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, —É–ø–∞–ª `endpoint_1`
(`api.openai.com`) –∏ –≤–æ—Ä–∫–µ—Ä —É—à—ë–ª –Ω–∞ –±—ç–∫–∞–ø –≤ `endpoint_2`.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ (–ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏)

> –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–∞–º –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ `type=text` ‚Üí 400.

### 1. –°—Ç–∞—Ç—É—Å OpenAI-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ `/v1/responses` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∑–∞–ø—Ä–æ—Å—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ –≤–∞–ª–∏–¥–Ω—ã–π `input_text`.
- –û—Ç–≤–µ—Ç—ã OpenAI –ø—Ä–∏—Ö–æ–¥—è—Ç —Å –∫–æ–¥–æ–º `2xx`, –∞–¥–∞–ø—Ç–µ—Ä —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç `[ai][ok]` –∏ `[ai][parsed]`, –æ—à–∏–±–æ–∫ –∫–ª–∞—Å—Å–∞ `AI_NON_2XX` –Ω–µ—Ç.
- –û—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ (`invalid_request_error`/400) –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è.

### 2. –°—Ç–∞—Ç—É—Å Telegram-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- –í—Å–µ –≤—ã–∑–æ–≤—ã `sendTyping` –∏ `sendText` –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ, –ø–æ–ª–µ `telegramOk` —Å—Ç–∞–±–∏–ª—å–Ω–æ `true`.

### 3. Self-test: —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

- Self-test –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π payload –≤ OpenAI, –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç —Å —Ä–∞–±–æ—á–∏–º —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ö—É-–ø—Ä–∏–µ–º pong¬ª).
- –ü—Ä–∏ —ç—Ç–æ–º `openAiOk:false` –∏ `openAiReason:"marker_in_fallback_output"` ‚Äî –ø—Ä–∏—á–∏–Ω–∞ –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –º–∞—Ä–∫–µ—Ä–∞ –≤ –æ—Ç–≤–µ—Ç–µ –º–æ–¥–µ–ª–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ª–æ–∂–Ω–æ–º—É –æ—Ç—Ä–∏—Ü–∞–Ω–∏—é –±–µ–∑ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏.

### 4. –õ–æ–≥–∏ Cloudflare tail

- –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π `[ai][non-2xx]` –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–≤ 4xx/5xx —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã OpenAI.
- –í—Å–µ self-test –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø—É—Ç—å `request ‚Üí 2xx ‚Üí parsed`.

### 5. –°—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏ –∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Variant C —Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑ `AI_QUEUE_CONFIG` –≤ KV, —Å–ø–∏—Å–æ–∫ `AI_BASE_URLS` —Ç–∞–∫–∂–µ —á–∏—Ç–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
- Failover/rotation –Ω–µ –º–µ–Ω—è–ª–∏—Å—å –∏ –Ω–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ —Ä–∞–º–∫–∞—Ö —Ñ–∏–∫—Å–∞; –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ç.

### 6. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è

- –õ–æ–≥–∏–∫–∞ self-test –∑–∞–≤—è–∑–∞–Ω–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ä; –ø—Ä–∏ –µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è `fallback`, –ø–æ—ç—Ç–æ–º—É —Å—Ç–æ–∏—Ç —É—Ç–æ—á–Ω–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É –º–æ–¥–µ–ª–∏ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∞—Ä–∫–µ—Ä–∞.
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ `openAiEndpointId`/`openAiBaseUrl` –≤ –æ—Ç–≤–µ—Ç self-test —É–ø—Ä–æ—Å—Ç–∏—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤.
- –í–∞–ª–∏–¥–∞—Ü–∏—è `AI_BASE_URLS` –¥–æ–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ HTTPS-—Ö–æ—Å—Ç—ã; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏.

### 7. –ò—Ç–æ–≥

- –û—à–∏–±–∫–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞; –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å OpenAI –∏ Telegram —Ä–∞–±–æ—Ç–∞—é—Ç —à—Ç–∞—Ç–Ω–æ.
- Self-test –≤—ã–¥–∞—ë—Ç false-negative –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –∏–∑-–∑–∞ –º–∞—Ä–∫–µ—Ä–Ω–æ–π –ª–æ–≥–∏–∫–∏, –∞ –Ω–µ –∏–∑-–∑–∞ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: AI Queue Stress Test (–ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏)

> –°—Ç—Ä–µ—Å—Å-–ø—Ä–æ–≥–æ–Ω –æ—á–µ—Ä–µ–¥–∏ AI –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ payload–æ–≤ –Ω–∞ `input_text`.

### 1. –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- –ü—Ä–æ–≤–µ—Ä—è–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ `AI_QUEUE_CONFIG` –∏–∑ KV –≤ —Ä–∞–Ω—Ç–∞–π–º–µ –ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ system-turn.
- –¶–µ–ª—å ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–∏–º–∏—Ç–µ—Ä–∞ (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å, –æ—á–µ—Ä–µ–¥—å, —Ç–∞–π–º–∞—É—Ç—ã –∏ —Ä–µ—Ç—Ä–∞–∏) –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∏–∫–æ–≤—É—é –Ω–∞–≥—Ä—É–∑–∫—É –±–µ–∑ failover.

### 2. –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç stress-run

- –ò—Å—Ç–æ—á–Ω–∏–∫–∏: Cloudflare tail (`ai-queue-stress-tail.json`) –∏ `/admin/diag?q=ai-queue`.

#### 2.1. –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏

- `status:"ok"`, `active:0`, `queued:0`, `droppedSinceBoot:0`, `avgWaitMs:0`, `lastDropAt:null`.
- –õ–∏–º–∏—Ç—ã —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ KV: `maxConcurrency:4`, `maxQueue:64`, `retryMax:3`, `requestTimeoutMs:18000`.
- `sources.*="kv"` –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ `AI_QUEUE_CONFIG`.

#### 2.2. –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏ failover

- `activeBaseUrl=https://api.openai.com/v1/responses`.
- `backupBaseUrls=["https://api.openai.com/v1/responses?cf_region=eu"]`.
- `failoverCounts.endpoint_1=0`, `failoverCounts.endpoint_2=0`; –≤ –ª–æ–≥–∞—Ö –Ω–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π, failover –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª—Å—è.

#### 2.3. –†–∞–±–æ—Ç–∞ –∞–¥–∞–ø—Ç–µ—Ä–∞ OpenAI –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–¥–µ–Ω –∫–æ–Ω–≤–µ–π–µ—Ä `[ai][request] ‚Üí [ai][ok] ‚Üí [ai][parsed]`.
- –û—à–∏–±–æ–∫ –∫–ª–∞—Å—Å–∞ `AI_NON_2XX` –Ω–µ—Ç.
- –¢–∞–π–º–∞—É—Ç—ã (`[ai][timeout]`) –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ä–µ—Ç—Ä–∞–∏ (`[ai][retry]`), –ø–æ—Å–ª–µ —á–µ–≥–æ –∑–∞–ø—Ä–æ—Å—ã –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è —É—Å–ø–µ—Ö–æ–º.

#### 2.4. D1-stress —Å–∏–≥–Ω–∞–ª—ã

- Tail —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç `Too many API requests by single worker invocation`, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ `retryable:true` –±–µ–∑ `max_retries_exceeded`.
- –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–º—É —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥—É.

### 3. –í—ã–≤–æ–¥—ã –ø–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

- –û—á–µ—Ä–µ–¥—å –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É: –¥—Ä–æ–ø–æ–≤ –Ω–µ—Ç, failover –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ KV.
- OpenAI-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–∞, —Ä–µ—Ç—Ä–∞–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã.
- –ü—Ä–æ–≥–æ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—è–º RoadMap 4.4.

### 4. –°–∏–≥–Ω–∞–ª—ã –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ —É–ª—É—á—à–µ–Ω–∏–π

1. **–¢–∞–π–º–∞—É—Ç—ã –∏ —Ä–µ—Ç—Ä–∞–∏.** –ö—Ä–∞—Ç–∫–∏–µ `[ai][timeout] ‚Üí [ai][retry]` –æ–∂–∏–¥–∞–µ–º—ã –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π; –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Ç–æ–∏—Ç –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –¥–æ–ø—É—Å—Ç–∏–º—É—é –¥–æ–ª—é.
2. **Failover-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.** –ü–æ–ª–µ–∑–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å `/admin/diag?q=ai-queue` –ø–æ–ª—è–º–∏ `activeEndpointId` –∏ `failoverCounts`, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–µ–µ –ø–æ–Ω–∏–º–∞—Ç—å –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ base URL.
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è AI_BASE_URLS.** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å whitelist –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Ö–æ—Å—Ç–æ–≤ –∏–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é KV, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –æ—à–∏–±–æ—á–Ω—ã–µ URL.

### 5. –û—Ç–≤–µ—Ç—ã –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

1. **–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã.** –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ; –æ—á–µ—Ä–µ–¥—å –∏ –∞–¥–∞–ø—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞—é—Ç —à—Ç–∞—Ç–Ω–æ, –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–æ—Ä–∞–±–æ—Ç–æ–∫ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
2. **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å.** `maxConcurrency:4` –ø—Ä–∏ `avgWaitMs:0` –¥–∞—ë—Ç —É—Å—Ç–æ–π—á–∏–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É ‚âà4 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –ø–æ—Ç–æ–∫) –ø—Ä–∏ —Å—Ä–µ–¥–Ω–∏—Ö 1-—Å–µ–∫—É–Ω–¥–Ω—ã—Ö –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞—Ö; –∑–∞–ø–∞—Å –ø–æ –æ—á–µ—Ä–µ–¥–∏ `maxQueue:64` –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∏–∫–∏.
3. **–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏.** –ù–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏ –¥–æ 64 —à—Ç—É–∫; –µ—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω, –≤–æ—Ä–∫–µ—Ä –≤–µ—Ä–Ω—ë—Ç –¥—Ä–æ–ø (`droppedSinceBoot` –Ω–∞—á–Ω—ë—Ç —Ä–∞—Å—Ç–∏), —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É–∂–µ –≤–∑—è—Ç—ã—Ö –∑–∞–¥–∞—á.
4. **–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ OpenAI.** –ö–ª–∏–µ–Ω—Ç —É–≤–∏–¥–∏—Ç –¥–æ–ª—å—à–µ —Ç—è–Ω—É—â–∏–π—Å—è `sendTyping`, –ø–æ–∫–∞ –≤–æ—Ä–∫–µ—Ä –∂–¥—ë—Ç –¥–æ `requestTimeoutMs` (18 —Å–µ–∫—É–Ω–¥). –ü—Ä–∏ —É—Å—Ç–æ–π—á–∏–≤–æ–π –∑–∞–¥–µ—Ä–∂–∫–µ –ø–æ–≤–µ—Ä—Ö —Ç–∞–π–º–∞—É—Ç–∞ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ—Ç—Ä–∞–π –¥–æ `retryMax:3`; —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤–º–µ—Å—Ç–æ typing-–∏–Ω–¥–∏–∫–∞—Ü–∏–∏.

### –ö–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏ –æ—Ç–≤–µ—Ç–æ–≤

- –ü—Ä–∏ –±–æ–µ–≤—ã—Ö –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö —Å–º–æ—Ç—Ä–∏ —Ö–≤–æ—Å—Ç –ª–æ–≥–æ–≤ `DialogEngine`: `[dialog-engine][sendText][error]` –¥–æ–ª–∂–µ–Ω —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ–º
  —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è `assistant`. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–ø–∏—Å–µ–π –±–µ–∑ `messageId` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö ‚Äî –∫—Ä–∏—Ç–µ—Ä–∏–π –ø—Ä–∏—ë–º–∫–∏ —à–∞–≥–∞ 3 –¥–æ—Ä–æ–∂–Ω–æ–π –∫–∞—Ä—Ç—ã (—Å–º.
  `memory-bank/logs/cloudflare-sendtext-failure-2025-11-16.log`). –°–Ω–∏–º–æ–∫/—Å—Å—ã–ª–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ diagnostics –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–º –ø—Ä–æ–≥–æ–Ω–µ.

## `GET /admin/envz`

–í—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–∞–∫–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–¥–∞–Ω—ã –∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞.

## `GET /admin/diag`

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Ä—É—á–∫–∞. –ß–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `q` –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Ç–∏–ø
–ø—Ä–æ–≤–µ—Ä–∫–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤–∞—Ä–∏–∞–Ω—Ç—ã:

- `q=telegram.getMe` ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å `getMe` –∫ Bot API –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç
  `ok`, HTTP-—Å—Ç–∞—Ç—É—Å, `description`, –∞ —Ç–∞–∫–∂–µ –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω (`tokenMasked`).
- `q=bindings` ‚Äî –ø—Ä–æ–≥–æ–Ω—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ D1 –∏ KV. –í –æ—Ç–≤–µ—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
  –ø–æ–ª–µ `secrets`, –æ—Ç—Ä–∞–∂–∞—é—â–µ–µ –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è
  –∑–Ω–∞—á–µ–Ω–∏–π.
- `q=ai-queue` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ AI-–ª–∏–º–∏—Ç–µ—Ä–∞. –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç
  —Å–≤–æ–¥–∫—É `{ status, active, queued, maxConcurrency, maxQueue, requestTimeoutMs,
  retryMax, droppedSinceBoot, avgWaitMs, lastDropAt }` –∏ –±–ª–æ–∫–∏ `endpoints`
  (`activeBaseUrl`, `backupBaseUrls`, `failoverCounts`) –∏ `sources`. –í `sources`
  –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ª–∏–º–∏—Ç–∞ (`kv`/`env`/`default`), —Å–ø–∏—Å–æ–∫
  –∞–∫—Ç–∏–≤–Ω—ã—Ö `baseUrls`, `endpointFailoverThreshold` –∏ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —Ç–µ–∫—É—â–∏–π
  `AI_CONTROL_KV`. –ë–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç, –∫–∞–∫–æ–π base URL
  —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º, –∫–∞–∫–∏–µ –±—ç–∫–∞–ø—ã –≤–∫–ª—é—á–µ–Ω—ã –∏ –ø–æ—á–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, KV –ø–æ–¥–º–µ–Ω–∏–ª
  –¥–µ—Ñ–æ–ª—Ç). –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è –¥–≤—É—Ö—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã OpenAI ‚Äî
  –µ—Å–ª–∏ self-test —É–ø–∞–ª, –º–æ–∂–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å `openAiBaseUrl`/`openAiEndpointId`
  —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –æ—á–µ—Ä–µ–¥–∏ –∏ –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∞—è –Ω–æ–¥–∞ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç.

## `GET /admin/known-users/clear`

–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç in-memory –∫—ç—à UTM-–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON-–æ—Ç–≤–µ—Ç `{ "ok": true, "cleared": <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π> }`,
–≥–¥–µ `cleared` ‚Äî —á–∏—Å–ª–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.

> –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—á–∫—É –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ `/start src_TEST-CAMPAIGN` ‚Üí ¬´ping¬ª: –ø–æ–∫–∞ –∫—ç—à –Ω–µ –æ—á–∏—â–µ–Ω, –æ—Ç–≤–µ—Ç –ø–æ–∫–∞–∂–µ—Ç `size` –∏ `userIdHashes[]` –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º `utmSource`. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ —Ü–µ–ø–æ—á–∫–∞ `/start` ‚Üí `knownUsersCache` ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∫–∏–Ω—É–ª–∞ UTM –∏ —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç—É –¥–∞–∂–µ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ payload.

### –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–∏—ë–º–∫–∏ `/start <utm>`
1. –û—Ç–ø—Ä–∞–≤—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–∏–ø–ª–∏–Ω–∫ `/start <utm>` –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–π —Ü–µ–ø–æ—á–∫—É –ª–æ–≥–æ–≤ `[utm-tracking] incoming payload` ‚Üí `[telegram-webhook] normalized message` ‚Üí `[utm-tracking] saveUser result ‚Ä¶ utmSource:"<utm>" utmDegraded:false`.
2. –í—ã–ø–æ–ª–Ω–∏ `wrangler d1 execute DB --command "SELECT user_id, utm_source FROM users WHERE user_id='<id>'"` –∏ –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ `utm_source` —Ä–∞–≤–µ–Ω –∏—Å—Ö–æ–¥–Ω–æ–π –º–µ—Ç–∫–µ.
3. –û—Ç–ø—Ä–∞–≤—å 1‚Äì2 —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ payload –∏ —É–±–µ–¥–∏—Å—å –ø–æ tail-–ª–æ–≥—É, —á—Ç–æ `hasStartPayload:false` –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö `saveUser result` –¥–ª—è —Ç–æ–≥–æ –∂–µ `userId` –Ω–µ—Ç ‚Äî —ç—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Ä–∞–±–æ—Ç—É `knownUsersCache`.
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã–∑–æ–≤–∏ `/admin/diag?q=ai-queue`, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é –æ—á–µ—Ä–µ–¥–∏/—Ç–∞–π–º–∞—É—Ç—ã OpenAI –∫–∞–∫ –ø–µ—Ä–≤–æ–ø—Ä–∏—á–∏–Ω—É fallback ¬´–Ø –Ω–∞ —Å–µ–∫—É–Ω–¥—É –æ—Ç–≤–ª–µ–∫—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â—ë —Ä–∞–∑ üîÅüí¨¬ª.

## `POST /admin/d1-stress`

–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π –ø—Ä–æ–≥–æ–Ω D1 –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º —Ñ–ª–∞–≥–µ `STRESS_TEST_ENABLED`.
–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ñ–ª–∞–≥ –≤—ã–∫–ª—é—á–µ–Ω, –ø–æ—ç—Ç–æ–º—É —Ä—É—á–∫–∞ –æ—Ç–≤–µ—á–∞–µ—Ç `404 Not Found` –∏ –Ω–∏—á–µ–≥–æ –Ω–µ
–∑–∞–ø—É—Å–∫–∞–µ—Ç. –î–ª—è –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞–π—Ç–µ `STRESS_TEST_ENABLED=1` (—á–µ—Ä–µ–∑ Secrets/Vars) –∏
–æ–±–Ω–æ–≤–∏—Ç–µ –≤–æ—Ä–∫–µ—Ä.

–ó–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ `x-admin-token` –∏ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å–æ —Å–≤–æ–¥–∫–æ–π.
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:

- `durationSec` ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–æ–Ω–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 120, –º–∞–∫—Å–∏–º—É–º 300).
- `concurrency` ‚Äî `auto` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ 8‚Äì32 –ø–æ—Ç–æ–∫–æ–≤) –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ
  —á–∏—Å–ª–æ –ø–æ—Ç–æ–∫–æ–≤ (1‚Äì32).

–í–æ –≤—Ä–µ–º—è –ø—Ä–æ–≥–æ–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ `saveUser` –∏ `appendMessage` –Ω–∞–¥
—Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –≤—Å–µ –∑–∞–ø–∏—Å–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è `metadata.stress=true` –∏
`metadata.runId=<uuid>`.

### –õ–æ–≥–∏ Cloudflare

–§–∏–ª—å—Ç—Ä—É–π—Ç–µ –ø–æ –∫–ª—é—á–∞–º `$metadata.message`:

- `[d1-stress][start] runId=<uuid> durationSec=<int> concurrency=<int>`
- `[d1-stress][retry] op=<op> attempt=<n> error=<class|code>`
- `[d1-stress][success_after_retry] op=<op> attempts=<n>`
- `[d1-stress][max_retries_exceeded] op=<op> attempts=<n> error=<class|code>`
- `[d1-stress][non_retryable] op=<op> error=<class|code>`
- `[d1-stress][done] runId=<uuid> totals={<json>}`

–û—Ç–≤–µ—Ç —Ä—É—á–∫–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ (`attemptsDistribution`) –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã,
–ø–æ—ç—Ç–æ–º—É –º–æ–∂–Ω–æ —Å–≤–µ—Ä—è—Ç—å —á–∏—Å–ª–∞ —Å –ª–æ–≥–∞–º–∏.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: –≠–∫—Å–ø–æ—Ä—Ç (–®–∞–≥ 5.3) ‚Äî –ü–æ–ª–Ω–æ—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞

> –ë–æ–µ–≤–æ–π –ø—Ä–æ–≥–æ–Ω `/export` –≤ –∞–¥–º–∏–Ω-—á–∞—Ç–µ. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å —à–∞–≥–æ–º –ú7.–®5.3 RoadMap.

### 1. –ò—Ç–æ–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏

- –ü–æ–ª—É—á–µ–Ω–æ 1‚ÄØ754 —Å—Ç—Ä–æ–∫–∏ ‚Äî –±–æ–ª—å—à–µ –ª–∏–º–∏—Ç–∞ 1‚ÄØ000 —Å—Ç—Ä–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –ø–∞–≥–∏–Ω–∞—Ü–∏—è D1 –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–∞.
- –ö—É—Ä—Å–æ—Ä `x-next-cursor` –æ–±—Ä–∞–±–æ—Ç–∞–Ω ‚â•2 —Ä–∞–∑–∞, CSV —Å–æ–±—Ä–∞–Ω –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∏–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–µ UTM-–º–µ—Ç–∫–∏ (`src_DIAG`, `src_TEST-GREETING`, `stress_test`), –≤ CSV —É –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω `utm_source`.
- –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ `empty export`, `truncated`, `[d1-storage] column missing` –∏ —Ç. –ø.
- –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–∏–ª CSV –≤ Telegram-—á–∞—Ç; —Ñ–∞–π–ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Numbers/Excel –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π.

### 2. –§—Ä–∞–≥–º–µ–Ω—Ç—ã –ª–æ–≥–æ–≤

```
"rowCount": 1754,
"sending export to telegram"

"utmSources": [
  "src_DIAG",
  "src_TEST-GREETING",
  "stress_test"
]

"x-next-cursor": "..."
```

–û—à–∏–±–æ–∫ `d1-storage` –≤ –ª–æ–≥–∞—Ö –Ω–µ—Ç.

### 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ CSV

- –ö–æ–ª–æ–Ω–∫–∏: `id, tg_user_id, tg_username, tg_first_name, tg_last_name, last_message_at, utm_source, created_at`.
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: 1‚ÄØ754.
- –í—ã–±–æ—Ä–æ—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∑–Ω–∞—á–µ–Ω–∏–π `utm_source` –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞.

### 4. –ü–æ–±–æ—á–Ω–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∏ –º–µ—Ä–∞

- –í tail –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ `KV PUT failed: 400 Invalid expiration_ttl of 30` ‚Äî Cloudflare KV —Ç—Ä–µ–±—É–µ—Ç TTL ‚â• 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∫—É–ª–¥–∞—É–Ω–∞ `/export`.
- TTL –ø–æ–≤—ã—à–µ–Ω –¥–æ 60 —Å–µ–∫—É–Ω–¥ (—Å–º. `apps/worker-main/features/export/telegram-export-command.ts`), —á—Ç–æ–±—ã rate-limit –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–ª –ø–æ–≤—Ç–æ—Ä—ã –∏ –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞–ª –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.

### 5. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

1. –í—ã–∑–≤–∞—Ç—å –±–æ–µ–≤–æ–π `/export` –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É —Å ‚â•1‚ÄØ500 —Å—Ç—Ä–æ–∫; —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `rowCount` –≤ –ª–æ–≥–∞—Ö > 1‚ÄØ000 –∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω `x-next-cursor`.
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏—Ç–æ–≥–æ–≤—ã–π CSV —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è (–Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏).
3. –°–≤–µ—Ä–∏—Ç—å `utmSources` –∏–∑ –ª–æ–≥–æ–≤ —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –∫–æ–ª–æ–Ω–∫–∏ `utm_source` –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤—ã–±–æ—Ä–æ—á–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö.
4. –£–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ª–æ–≥–æ–≤ `empty export`, `truncated`, `[d1-storage] column missing` –∏–ª–∏ `[export] failed`.
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É —Ñ–∞–π–ª–∞ –±–æ—Ç–æ–º –∏ —É—Å–ø–µ—à–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ CSV –≤ Numbers/Excel.
6. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π `Invalid expiration_ttl` ‚Äî –∫—É–ª–¥–∞—É–Ω –¥–æ–ª–∂–µ–Ω –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è —Å TTL 60 —Å–µ–∫—É–Ω–¥ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–π `/export` –≤ —Ç–µ—á–µ–Ω–∏–µ –º–∏–Ω—É—Ç—ã.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: Admin Access –∏ –ª–∏–º–∏—Ç–µ—Ä `admin_export` (25.11.2025)

> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Ç–æ—á–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–¥–∞—á–µ–π –ø–æ —Å–Ω—è—Ç–∏—é –ª–∏–º–∏—Ç–∞: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º whitelisting/–∫—ç—à –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É `/admin` –ø–æ `admin_export`.

### 1. `/admin/access` (–¥–æ `invalidate`, —Å `invalidate=all`, –ø–æ—Å–ª–µ)
- JSON-–æ—Ç–≤–µ—Ç—ã —Ç—Ä—ë—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤ `memory-bank/logs/admin-access-2025-11-25.json` –∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π `whitelist` (`270641809`, `402077679`), –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π `kvRaw` –∏ `health.status="ok"` –¥–ª—è –æ–±–æ–∏—Ö ID –¥–æ, –≤–æ –≤—Ä–µ–º—è –∏ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞.„ÄêF:memory-bank/logs/admin-access-2025-11-25.json‚Ä†L1-L52„Äë
- –ó–∞–ø—Ä–æ—Å —Å `invalidate=all` –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ `cacheControl.invalidateApplied=true`, –∞ —Å–ª–µ–¥—É—é—â–∏–π –≤—ã–∑–æ–≤ —á–∏—Ç–∞–µ—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ KV (`cacheSnapshot:"miss_after_invalidate"`), —Ç–æ –µ—Å—Ç—å whitelist-–∫—ç—à –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç—Å—è.„ÄêF:memory-bank/logs/admin-access-2025-11-25.json‚Ä†L21-L52„Äë

### 2. Telegram –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (`Access diagnostics ping‚Ä¶`)
- –§—Ä–∞–≥–º–µ–Ω—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –≤ –∞–¥–º–∏–Ω-—á–∞—Ç–µ (`memory-bank/logs/telegram-access-diagnostics-2025-11-25.md`) –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —à–µ—Å—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ¬´Access diagnostics ping‚Ä¶¬ª, –ø–æ –¥–≤–∞ –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ `/admin/access`, —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é HTTP-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ Telegram-–ø–∏–Ω–≥–∞–º–∏„ÄÇ„ÄêF:memory-bank/logs/telegram-access-diagnostics-2025-11-25.md‚Ä†L1-L11„Äë

### 3. `wrangler tail` ‚Äî `admin export rate limited`
- –õ–æ–≥ `memory-bank/logs/wrangler-admin-export-rate-limit-2025-11-25.log` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ `[admin.export][warn] admin export rate limited` –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏–π `HTTP 429` –ø–æ –º–∞—Ä—à—Ä—É—Ç—É `/admin` —Å —Ç–µ–º–∏ –∂–µ `chatIdHash`/`fromIdHash`, —á—Ç–æ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∫–æ–º–∞–Ω–¥ –∞–¥–º–∏–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–º `admin_export`-–ª–∏–º–∏—Ç–µ—Ä–æ–º –∏ 60-—Å–µ–∫—É–Ω–¥–Ω—ã–º cooldown-–æ–∫–Ω–æ–º.„ÄêF:memory-bank/logs/wrangler-admin-export-rate-limit-2025-11-25.log‚Ä†L1-L2„Äë

### 4. `/admin/diag?q=export-rate`
- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–µ–∑ `status/feature/limit/windowMs/totals/buckets/lastLimit`, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π —É–≤–∏–¥–µ—Ç—å, —Å–∫–æ–ª—å–∫–æ `/export`
  –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ—à–ª–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–∫–Ω–∞ –∏ –∫–∞–∫–æ–π userIdHash –ø–æ—Å–ª–µ–¥–Ω–∏–º –ø–æ–π–º–∞–ª `429`. `totals.ok` —Ä–∞—Å—Ç—ë—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω—ã—Ö —ç–∫—Å–ø–æ—Ä—Ç–Ω—ã—Ö
  –∑–∞–ø—Ä–æ—Å–∞—Ö, `totals.limit` ‚Äî –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ –ª–∏–º–∏—Ç–µ—Ä–∞, –∞ –∫–∞–∂–¥—ã–π bucket —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç `ok/limit`, `firstSeenAt/lastSeenAt` –∏
  `lastUserIdHash`.„ÄêF:apps/worker-main/features/export/export-rate-diag-route.ts‚Ä†L1-L19„Äë„ÄêF:apps/worker-main/features/export/export-rate-telemetry.ts‚Ä†L1-L154„Äë
- –ü—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ `/admin export` –≤–æ—Ä–∫–µ—Ä —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É–µ—Ç —Ö—ç—à userId, bucket, –ª–∏–º–∏—Ç –∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (`remaining`)
  –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ `[admin export rate limited ‚Ä¶]`. –≠—Ç–∏ –∂–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏, —Ç–∞–∫ —á—Ç–æ –ø—Ä–æ—â–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—Ç—å `wrangler`
  tail —Å `/admin/diag?q=export-rate` –∏ –ø–æ–Ω–∏–º–∞—Ç—å, –≤ –∫–∞–∫–æ–º –æ–∫–Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∑–∞–ø—Ä–æ—Å—ã –∏ —Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ —É–∂–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ.„ÄêF:apps/worker-main/features/export/telegram-export-command.ts‚Ä†L651-L689„Äë

### 5. –†–µ–∑—é–º–µ
Whitelisting –∏ –∫—ç—à `AdminAccess` —Ä–∞–±–æ—Ç–∞—é—Ç —à—Ç–∞—Ç–Ω–æ (–∫–µ—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø–æ –∑–∞–ø—Ä–æ—Å—É, –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–∏–Ω–≥–∏ –¥–æ—Ö–æ–¥—è—Ç –¥–æ –æ–±–æ–∏—Ö ID), –æ–¥–Ω–∞–∫–æ –¥–∞–ª—å–Ω–µ–π—à–∏–µ `/admin`-–∫–æ–º–∞–Ω–¥—ã –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–ª—É—á–∞—é—Ç `HTTP 429` –∏–∑-–∑–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–µ—Ä–∞ `admin_export`, –ø–æ—ç—Ç–æ–º—É —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –±–ª–æ–∫–µ—Ä–æ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–µ–π.„ÄêF:memory-bank/logs/admin-access-2025-11-25.json‚Ä†L1-L52„Äë„ÄêF:memory-bank/logs/telegram-access-diagnostics-2025-11-25.md‚Ä†L1-L11„Äë„ÄêF:memory-bank/logs/wrangler-admin-export-rate-limit-2025-11-25.log‚Ä†L1-L2„Äë

### 6. –°—Ç–∞—Ç—É—Å 26.11.2025 ‚Äî –ª–∏–º–∏—Ç —Å–Ω—è—Ç
- –°–Ω–∏–º–∫–∏ `RATE_LIMIT_KV` –¥–æ –∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –∫–ª—é—á–∞ `rate_limit:scope:admin_export:chat:136236606:user:136236606:bucket:20407` –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç —É–¥–∞–ª–µ–Ω–∏–µ –∫—É–ª–¥–∞—É–Ω–∞ (–∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 50 –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–∞).„ÄêF:memory-bank/logs/rate-limit-kv-2025-11-26.md‚Ä†L1-L45„Äë
- `wrangler tail` –ø–æ `/admin`, `/admin status` –∏ safe-–ø–∏–Ω–≥—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç—Ä–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö `HTTP 200` —Å –ª–æ–≥–∞–º–∏ `admin help sent`, `system_admin_status`, `[safe] done`, —Ç–æ –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã —Å–Ω–æ–≤–∞ –æ—Ç–≤–µ—á–∞—é—Ç —à—Ç–∞—Ç–Ω–æ –±–µ–∑ 429.„ÄêF:memory-bank/logs/wrangler-tail-admin-2025-11-26.md‚Ä†L1-L24„Äë
- –õ–æ–≥ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç `/admin` –ø–æ—Å–ª–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ —Å–ª—É–∂–∏—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ ¬´Access diagnostics ping¬ª.„ÄêF:memory-bank/logs/telegram-admin-recovery-2025-11-26.md‚Ä†L1-L17„Äë
- **–ò—Ç–æ–≥:** –ª–∏–º–∏—Ç —Å–Ω—è—Ç, –∫–æ–º–∞–Ω–¥—ã –æ—Ç–≤–µ—á–∞—é—Ç —à—Ç–∞—Ç–Ω–æ, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.
