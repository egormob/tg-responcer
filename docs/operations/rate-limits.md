# –ü–æ–≤–µ–¥–µ–Ω–∏–µ rate limit –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä—É—á–∫–∞–º–∏

## –¶–µ–ø–æ—á–∫–∞ `DialogEngine ‚Üí rateLimit ‚Üí notifier ‚Üí fallback`
1. **`DialogEngine`** –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Å –≤—ã–∑–æ–≤–∞ `rateLimit.checkAndIncrement` —Å `userId` –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (chat/thread). –ï—Å–ª–∏ –∞–¥–∞–ø—Ç–µ—Ä –≤–µ—Ä–Ω—É–ª `limit`, —è–¥—Ä–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `status: 'rate_limited'` –∏ –¥–∞–ª—å—à–µ –ø–æ —Ü–µ–ø–æ—á–∫–µ –Ω–µ –∏–¥—ë—Ç.„ÄêF:apps/worker-main/core/DialogEngine.ts‚Ä†L41-L86„Äë
2. **`createRouter`** –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `DialogEngine` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å. –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç `rate_limited`, –æ–Ω —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ—Ç `rateLimitNotifier.notify`, –∞ –∑–∞—Ç–µ–º, –µ—Å–ª–∏ notifier –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—Ç–≤–µ—Ç–∏–ª `handled: false`, –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É `RATE_LIMIT_FALLBACK_TEXT` –æ–±—ã—á–Ω—ã–º `messaging.sendText`. –≠—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∞–∂–µ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ notifier –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–ª –∏ –ø–∏—Å–∞–ª –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –ª–æ–≥ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –æ—Ç —Ä–æ—É—Ç–µ—Ä–∞.„ÄêF:apps/worker-main/http/router.ts‚Ä†L660-L777„Äë
3. **`rateLimitNotifier`** —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ c –ø–æ–¥—Å–∫–∞–∑–∫–æ–π –æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–Ω—è—Ç–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Ä—É–µ—Ç `rate limit notification sent`/`failed to send rate limit notification`. –û–Ω –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω, –ø–æ—ç—Ç–æ–º—É –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É fallback-—Ç–µ–∫—Å—Ç–∞, –∞ –≤ –ª–æ–≥–∞—Ö –≤–æ—Ä–∫–µ—Ä–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å `[router] rate limit notifier failed ‚Ä¶` –ø–µ—Ä–µ–¥ —Ä–µ–∑–µ—Ä–≤–Ω—ã–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º.„ÄêF:apps/worker-main/features/limits/rate-limit-notifier.ts‚Ä†L1-L103„Äë„ÄêF:apps/worker-main/http/router.ts‚Ä†L744-L777„Äë
4. **`RATE_LIMIT_FALLBACK_TEXT`** –∂—ë—Å—Ç–∫–æ –∑–∞–¥–∞–Ω –≤ —Ä–æ—É—Ç–µ—Ä–µ –∫–∞–∫ `ü•∂‚åõÔ∏è –õ–∏–º–∏—Ç –æ—Ç–≤–µ—Ç–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–µ–º –∂–µ MessagingPort, —á—Ç–æ –∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –æ—Ç–≤–µ—Ç—ã, –ø–æ—ç—Ç–æ–º—É —Ç–µ–ª–µ–≥—Ä–∞–º-–∫–ª–∏–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–µ–¥—ë—Ç —Å–µ–±—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ –¥–∞–∂–µ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.„ÄêF:apps/worker-main/http/router.ts‚Ä†L26-L34„Äë„ÄêF:apps/worker-main/http/router.ts‚Ä†L732-L777„Äë

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- **50 —Å–æ–æ–±—â–µ–Ω–∏–π / 24 —á–∞—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.** –ï—Å–ª–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ª–∏–º–∏—Ç, —Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è `DEFAULT_RATE_LIMIT = 50` –∏ `DEFAULT_RATE_LIMIT_WINDOW_MS = 24 * 60 * 60 * 1000` (—Å—É—Ç–∫–∏).„ÄêF:apps/worker-main/index.ts‚Ä†L95-L96„Äë
- **–ù–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.** –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –ª—é–±—ã–µ –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ø–∞–¥–∞—é—Ç –≤ `DialogEngine`, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Ä–∞–∑–ª–∏—á–∞–µ—Ç —Ä–æ–ª–∏ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–æ—Ç –∂–µ `RateLimitPort` –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤ —Ç–æ–º —á–∏—Å–ª–µ –¥–ª—è whitelisted –∞–¥–º–∏–Ω–æ–≤.„ÄêF:apps/worker-main/http/router.ts‚Ä†L660-L777„Äë
- **`RATE_LIMIT_KV` ‚Äî –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã, –Ω–æ –µ–≥–æ —Å–±–æ–π –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —á–∞—Ç.** –ê–¥–∞–ø—Ç–µ—Ä `createKvRateLimitAdapter` —á–∏—Ç–∞–µ—Ç/–ø–∏—à–µ—Ç —Å—á—ë—Ç—á–∏–∫ –≤ –∫–ª—é—á–∞—Ö –≤–∏–¥–∞ `rate_limit[:scope:<scope>][:chat:<chatId>][:thread:<threadId>]:user:<userId>:bucket:<N>`. –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏–ª–∏ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ ¬´—Ä–∞–∑—Ä–µ—à–∏—Ç—å¬ª (`return 'ok'`), –ø–æ—ç—Ç–æ–º—É –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è KV –≤—ã–∫–ª—é—á–∞–µ—Ç –ª–∏–º–∏—Ç –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ª–æ–º–∞—Ç—å –¥–∏–∞–ª–æ–≥.„ÄêF:apps/worker-main/adapters/kv-rate-limit/index.ts‚Ä†L24-L213„Äë
- **–¢—É–º–±–ª–µ—Ä `LIMITS_ENABLED`** (—Å–º. `createRateLimitToggle`) –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–æ–π—Ç–∏ RateLimitPort, –Ω–æ –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ fallback-—Ç–µ–∫—Å—Ç–∞ —ç—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç: –æ–Ω –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `status: 'rate_limited'`.„ÄêF:apps/worker-main/features/limits/rate-limit-toggle.ts‚Ä†L20-L132„Äë„ÄêF:apps/worker-main/http/router.ts‚Ä†L660-L777„Äë

## –ö–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –ª–∏–º–∏—Ç –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ
1. **–ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç.** –£–∑–Ω–∞–π—Ç–µ `userId`/`chatId` —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ namespace `RATE_LIMIT_KV`. –†–∞—Å—á–∏—Ç–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–π `bucket` –¥–ª—è —Å—É—Ç–æ—á–Ω–æ–≥–æ –æ–∫–Ω–∞: `node -e "const windowMs=24*60*60*1000;console.log(Math.floor(Date.now()/windowMs));"` (—Å–º. `computeWindowInfo`).„ÄêF:apps/worker-main/adapters/kv-rate-limit/index.ts‚Ä†L73-L139„Äë
2. **–ü–æ–¥—Ç—è–Ω–∏—Ç–µ —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞.** –í—ã–ø–æ–ª–Ω–∏—Ç–µ `wrangler kv:key get --namespace-id <RATE_LIMIT_KV> "rate_limit:user:<userId>:bucket:<bucket>" --text` –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞ 50. –ï—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é –∑–Ω–∞—á–µ–Ω–∏–µ–º 49, —á—Ç–æ–±—ã —Å–ª–µ–¥—É—é—â–∏–π –¥–∏–∞–ª–æ–≥ –ø—Ä–µ–≤—ã—Å–∏–ª –ø–æ—Ä–æ–≥.„ÄêF:apps/worker-main/adapters/kv-rate-limit/index.ts‚Ä†L104-L213„Äë„ÄêF:apps/worker-main/index.ts‚Ä†L95-L96„Äë
3. **–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –¥–æ–≤–µ–¥–∏—Ç–µ —Å—á—ë—Ç—á–∏–∫ –¥–æ –ø–æ—Ä–æ–≥–∞.** –ö–æ–º–∞–Ω–¥–æ–π `wrangler kv:key put --namespace-id <RATE_LIMIT_KV> "rate_limit:user:<userId>:bucket:<bucket>" --value 50 --expiration-ttl 86400` –∑–∞—Å—Ç–∞–≤—å—Ç–µ KV –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–ª–æ–∫ –æ–∫–Ω–∞ (TTL —Ä–∞–≤–µ–Ω –æ—Å—Ç–∞—Ç–∫–∞–º –¥–æ –∫–æ–Ω—Ü–∞ —Å—É—Ç–æ–∫; —Å–º. `toTtlSeconds`).„ÄêF:apps/worker-main/adapters/kv-rate-limit/index.ts‚Ä†L146-L213„Äë
4. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç.** –°–ª–µ–¥—É—é—â–µ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–π–¥—ë—Ç —á–µ—Ä–µ–∑ `DialogEngine`, –ø–æ–ª—É—á–∏—Ç `status: 'rate_limited'`, –∞ —Ä–æ—É—Ç–µ—Ä –≤—ã–∑–æ–≤–µ—Ç notifier –∏ fallback. –í `wrangler tail` –∏—â–∏—Ç–µ –∑–∞–ø–∏—Å—å `"message":"[router] rate limit notifier failed"` (–µ—Å–ª–∏ notifier –≤—ã–∫–ª—é—á–µ–Ω/–Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç) –∏–ª–∏ `[telegram] sendText status=200 ‚Ä¶ route:'rate_limit_fallback'`. –û–±–∞ –ª–æ–≥–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ `logMessagingCall` –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞ `RATE_LIMIT_FALLBACK_TEXT`.„ÄêF:apps/worker-main/http/router.ts‚Ä†L210-L333„Äë„ÄêF:apps/worker-main/http/router.ts‚Ä†L744-L777„Äë
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.** –û–∂–∏–¥–∞–µ–º–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ –Ω–∏–∂–µ; —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–∞–∂–µ –ø—Ä–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ notifier-–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ fallback –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ —É—Å–ª–æ–≤–∏–π –ø–æ—Å–ª–µ –Ω–µ—É—Å–ø–µ—Ö–∞ `notify`. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, —É–¥–∞–ª–∏—Ç–µ –∫–ª—é—á –∏–∑ KV –∏–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ–∫–Ω–∞.

## –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Å–∞–ø–ø–æ—Ä—Ç–∞
- **–§—Ä–∞–≥–º–µ–Ω—Ç –ª–æ–≥–∞:**

  ```text
  [router] rate limit notifier failed Error: Telegram 429
    at notify (...)
  [telegram] sendText status=200 { action: 'sendText', route: 'rate_limit_fallback', chatIdNormalizedHash: '...', fromIdHash: '...' }
  ```
  > –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ `console.warn` –≤ —Ä–æ—É—Ç–µ—Ä–µ, –≤—Ç–æ—Ä–∞—è ‚Äî –∏–∑ `logMessagingCall`, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∞—è –¥–æ—Å—Ç–∞–≤–∫—É fallback-–∞.„ÄêF:apps/worker-main/http/router.ts‚Ä†L210-L333„Äë„ÄêF:apps/worker-main/http/router.ts‚Ä†L744-L777„Äë

- **–°–∫—Ä–∏–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**

  ![–°–∫—Ä–∏–Ω rate-limit —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](rate-limit-fallback.svg)
