# MANUAL

## –ö–æ–Ω—Ñ–∏–≥ AI_QUEUE_CONFIG (–ª–∏–º–∏—Ç—ã –æ—á–µ—Ä–µ–¥–∏, —Ç–∞–π–º–∞—É—Ç—ã, —Ä–µ—Ç—Ä–∞–∏ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è OpenAI)

| –ß—Ç–æ —Ä–µ–≥—É–ª–∏—Ä—É–µ–º | –ö–ª—é—á –≤ `AI_QUEUE_CONFIG` (KV) | –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è ENV (fallback) | –î–µ—Ñ–æ–ª—Ç –≤ –∫–æ–¥–µ | –ì–¥–µ –∏—Å–∫–∞—Ç—å –≤ –≤–æ—Ä–∫–µ—Ä–µ |
| --- | --- | --- | --- | --- |
| –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –æ—á–µ—Ä–µ–¥–∏ | `"AI_MAX_CONCURRENCY"` | `AI_MAX_CONCURRENCY` | `DEFAULT_AI_MAX_CONCURRENCY = 4` | `apps/worker-main/index.ts` ‚Üí `readAiConcurrencyConfig()` ‚Üí `resolveValue('AI_MAX_CONCURRENCY', ‚Ä¶)` |
| –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ | `"AI_QUEUE_MAX_SIZE"` | `AI_QUEUE_MAX_SIZE` | `DEFAULT_AI_QUEUE_MAX_SIZE = 64` | –¢–æ—Ç –∂–µ `resolveValue('AI_QUEUE_MAX_SIZE', ‚Ä¶)` –≤ `readAiConcurrencyConfig()` |
| –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenAI (–º—Å) | `"AI_TIMEOUT_MS"` | `AI_TIMEOUT_MS` | `DEFAULT_AI_TIMEOUT_MS = 18_000` | `resolveValue('AI_TIMEOUT_MS', ‚Ä¶)` + –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ `[ai][timeout]` –≤ `apps/worker-main/features/ai/`, –∞–¥–∞–ø—Ç–µ—Ä –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º `DEFAULT_TIMEOUT_MS = 28_000` |
| –ú–∞–∫—Å–∏–º—É–º —Ä–µ—Ç—Ä–∞–µ–≤ | `"AI_RETRY_MAX"` | `AI_RETRY_MAX` | `DEFAULT_AI_RETRY_MAX = 3` | `resolveValue('AI_RETRY_MAX', ‚Ä¶)` + `apps/worker-main/features/ai/ai-queue.ts` (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏) |
| –ü–æ—Ä–æ–≥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ | `"AI_ENDPOINT_FAILOVER_THRESHOLD"` | `AI_ENDPOINT_FAILOVER_THRESHOLD` | `DEFAULT_AI_ENDPOINT_FAILOVER_THRESHOLD = 3` | `resolveValue('AI_ENDPOINT_FAILOVER_THRESHOLD', ‚Ä¶)` + –±–ª–æ–∫ `endpoints` –æ—á–µ—Ä–µ–¥–∏ |
| –û—Å–Ω–æ–≤–Ω—ã–µ URL OpenAI | `"AI_BASE_URLS"` –∏–ª–∏ `"aiBaseUrls"` (–º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫/–æ–±—ä–µ–∫—Ç–æ–≤) | `AI_BASE_URLS` | `["https://api.openai.com/v1/responses"]` | –ü–∞—Ä—Å–µ—Ä `parseAiBaseUrls()` –≤–Ω—É—Ç—Ä–∏ `readAiConcurrencyConfig()` –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è `apps/worker-main/features/ai/openai-client.ts` |

**–ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** `/admin/diag?q=ai-queue` –ø–µ—á–∞—Ç–∞–µ—Ç `sources` (–æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–æ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ª–∏–º–∏—Ç–∞), –∞ —Ç–∞–∫–∂–µ `activeBaseUrl`, `backupBaseUrls`, `failoverCounts`, `droppedSinceBoot`, `avgWaitMs`, `maxConcurrency`, `maxQueue`, `requestTimeoutMs`, `retryMax` –∏ `endpointFailoverThreshold`. –≠—Ç–æ –≥–ª–∞–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–∞–≤–æ–∫ KV.

### –ö–æ–≥–¥–∞ –∏ –∫–∞–∫ –º–µ–Ω—è—Ç—å –ª–∏–º–∏—Ç—ã

1. **AI_MAX_CONCURRENCY (4 ‚Üî 8/16).**
   - **–ö–æ–≥–¥–∞ –º–µ–Ω—è—Ç—å:** —Ä–µ–∑–∫–∏–π —Ä–æ—Å—Ç —Ç—Ä–∞—Ñ–∏–∫–∞, `avgWaitMs > 300` –∏ –æ—á–µ—Ä–µ–¥—å –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç. –ü–µ—Ä–µ–¥ –ø–æ–≤—ã—à–µ–Ω–∏–µ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ OpenAI –∏ —Å–∞–º –≤–æ—Ä–∫–µ—Ä –Ω–µ —É–ø–∏—Ä–∞—é—Ç—Å—è –≤ CPU (–≤ –ª–æ–≥–∞—Ö –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `Too many API requests by single worker invocation`).
   - **–ö–∞–∫ –º–µ–Ω—è—Ç—å:**
     ```json
     {
       "AI_MAX_CONCURRENCY": 8
     }
     ```
     –∑–∞–ª–µ–π—Ç–µ –≤ KV `AI_CONTROL_KV` ‚Üí –∫–ª—é—á `AI_QUEUE_CONFIG`. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç—å `maxConcurrency:8` –∏ `sources.maxConcurrency:"kv"`.
   - **–ì—Ä–∞–Ω–∏—Ü—ã:** 1‚Äì16. –ù–∏–∂–µ 2 –≤–æ—Ä–∫–µ—Ä —Å—Ç–∞–Ω–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ, –≤—ã—à–µ 16 Cloudflare –≤–æ—Ä–∫–µ—Ä –Ω–∞—á–Ω—ë—Ç —É–ø–∏—Ä–∞—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç ¬´32 open subrequests¬ª –∏ –Ω–∞—á–Ω—É—Ç—Å—è `Too many API requests‚Ä¶`.

2. **AI_QUEUE_MAX_SIZE (64 ‚Üî 96/128).**
   - **–ö–æ–≥–¥–∞ –º–µ–Ω—è—Ç—å:** –µ—Å–ª–∏ `queued == maxQueue` –∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –¥—Ä–æ–ø—ã (`droppedSinceBoot` —Ä–∞—Å—Ç—ë—Ç). –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–≥–ª–∞–¥–∏—Ç—å –ø–∏–∫, –Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É –æ—Ç–≤–µ—Ç–∞.
   - **–ö–∞–∫ –º–µ–Ω—è—Ç—å:** –¥–æ–±–∞–≤–∏—Ç—å –≤ JSON `"AI_QUEUE_MAX_SIZE": 96`. –ü–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ `/admin/diag` –∏ –º–µ—Ç—Ä–∏–∫—É `avgWaitMs`: –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è < 2000 –º—Å.
   - **–ì—Ä–∞–Ω–∏—Ü—ã:** 16 –º–∏–Ω–∏–º—É–º (–∏–Ω–∞—á–µ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç—å –æ—á–µ—Ä–µ–¥–∏ —Ç–µ—Ä—è–µ—Ç—Å—è), 128 –º–∞–∫—Å–∏–º—É–º (–±–æ–ª—å—à–µ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç typing > 2 –º–∏–Ω, –∞ openAi —Ç–∞–π–º–∞—É—Ç—ã —Å—Ä–µ–∂—É—Ç –≤—Å–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞).

3. **AI_TIMEOUT_MS (18_000 ‚Üî 24_000/12_000).**
   - **–ö–æ–≥–¥–∞ –º–µ–Ω—è—Ç—å:**
     - –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –¥–æ `22_000‚Äì28_000`, –µ—Å–ª–∏ OpenAI —Å—Ç–∞–±–∏–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ 18+ —Å–µ–∫, –Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫.
     - –£–º–µ–Ω—å—à–∞—Ç—å –¥–æ `12_000‚Äì15_000`, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å –≤–æ—Ä–∫–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–æ –≤—Ä–µ–º—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ –∏ –º–∞—Å—Å–æ–≤—ã—Ö —Ç–∞–π–º–∞—É—Ç–æ–≤).
   - **–ù–∞–±–ª—é–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** `[ai][timeout]` –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥–∞—Ö –∏ –≤—Å–ø–ª–µ—Å–∫ `retryMax` –ø–æ–ø—ã—Ç–æ–∫ –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ. –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–∞ —ç—Ç–∏ —Å–æ–±—ã—Ç–∏—è –¥–æ–ª–∂–Ω—ã –∏–ª–∏ –∏—Å—á–µ–∑–Ω—É—Ç—å (–ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏), –∏–ª–∏ —É—Å–∫–æ—Ä–∏—Ç—å failfast (–ø—Ä–∏ —É–º–µ–Ω—å—à–µ–Ω–∏–∏).
   - **–ì—Ä–∞–Ω–∏—Ü—ã:** 5_000‚Äì28_000 –º—Å (–º–µ–Ω—å—à–µ ‚Äî –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ –∏–∑‚Äë–∑–∞ —Å–µ—Ç–µ–≤—ã—Ö —Ö–≤–æ—Å—Ç–æ–≤, –±–æ–ª—å—à–µ ‚Äî Telegram/Cloudflare –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç; –∫–æ–¥–æ–≤—ã–π –ø–æ—Ç–æ–ª–æ–∫ 28‚ÄØ—Å).

4. **AI_RETRY_MAX (3 ‚Üî 1/5).**
   - **–ö–æ–≥–¥–∞ –º–µ–Ω—è—Ç—å:**
     - –ü–æ–Ω–∏–∂–∞—Ç—å –¥–æ 1‚Äì2, –µ—Å–ª–∏ OpenAI –¥–∞—ë—Ç —É—Å—Ç–æ–π—á–∏–≤—ã–µ 5xx –∏ –Ω—É–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É.
     - –ü–æ–≤—ã—à–∞—Ç—å –¥–æ 4‚Äì5, –µ—Å–ª–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –∏ –Ω—É–∂–Ω–æ ¬´–¥–æ–¥–∞–≤–∏—Ç—å¬ª —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç.
   - **–ü–æ–≤–µ–¥–µ–Ω–∏–µ:** –∫–∞–∂–¥—ã–π —Ä–µ—Ç—Ä–∞–π —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç—Å—è `[ai][retry] attempt=<n>` –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –∑–∞–Ω—è—Ç–∏–µ–º —Å–ª–æ—Ç–∞ –æ—á–µ—Ä–µ–¥–∏. –°–ª–µ–¥–∏—Ç–µ, —á—Ç–æ–±—ã `avgWaitMs` –Ω–µ —Ä–æ—Å, –∏–Ω–∞—á–µ —ç—Ñ—Ñ–µ–∫—Ç –æ–±—Ä–∞—Ç–Ω—ã–π.

5. **AI_ENDPOINT_FAILOVER_THRESHOLD (3 ‚Üî 1/5).**
   - **–ö–æ–≥–¥–∞ –º–µ–Ω—è—Ç—å:** –ø–æ—Ä–æ–≥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É base URLs. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π failover ‚Äî —Å—Ç–∞–≤—å—Ç–µ 1 (–ª—é–±–∞—è –æ—à–∏–±–∫–∞ —Å—Ä–∞–∑—É –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –±—ç–∫–∞–ø). –ï—Å–ª–∏ —à—É–º–Ω–∞—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è, –Ω–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤ —Ü–µ–ª–æ–º –∂–∏–≤–æ–π ‚Äî –ø–æ–≤—ã—à–∞–π—Ç–µ –¥–æ 5, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å ¬´—Ñ–ª–∞–ø–∏–Ω–≥–∞¬ª.
   - **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –≤ `/admin/diag` —Ä–∞—Å—Ç—ë—Ç `failoverCounts.endpoint_<n>`. –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –æ–∂–∏–¥–∞–µ–º–æ.

6. **AI_BASE_URLS (—Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã OpenAI).**
   - **–§–æ—Ä–º–∞—Ç KV:**
     ```json
     {
       "AI_BASE_URLS": [
         "https://api.openai.com/v1/responses",                     // –æ—Å–Ω–æ–≤–Ω–æ–π
         "https://api.openai.com/v1/responses?cf_region=eu"          // –±—ç–∫–∞–ø (–µ–≤—Ä–æ–ø–∞)
       ]
     }
     ```
   - **–ö–æ–≥–¥–∞ –º–µ–Ω—è—Ç—å:** –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ (—Å–º. –∞–ª–µ—Ä—Ç—ã OpenAI) –∏–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –Ω–∞–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –≤ –±–ª–∏–∂–Ω–∏–π —Ä–µ–≥–∏–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, `?cf_region=eu` –¥–ª—è –ï–≤—Ä–æ–ø—ã, `?cf_region=us` –¥–ª—è –°–®–ê, `?cf_region=apac` –¥–ª—è –ê–∑–∏–∞—Ç—Å–∫–æ‚Äë–¢–∏—Ö–æ–æ–∫–µ–∞–Ω—Å–∫–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞).
   - **–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞:** —Å–º–æ—Ç—Ä–∏–º –Ω–∞ `activeBaseUrl` –∏ `failoverCounts` –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ + tail Cloudflare (`[ai][failover]`). –ï—Å–ª–∏ –æ–¥–∏–Ω URL –¥–∞—ë—Ç 5xx –∏–ª–∏ timeouts, –¥–æ–±–∞–≤—å—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É —Å –¥—Ä—É–≥–∏–º `cf_region`. –ü—Ä–∏ –ø–æ–ª–Ω–æ–º –ø–∞–¥–µ–Ω–∏–∏ —Ä–µ–≥–∏–æ–Ω–∞ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–π URL –∏–∑ –º–∞—Å—Å–∏–≤–∞, —á—Ç–æ–±—ã –≤–æ—Ä–∫–µ—Ä —Å—Ä–∞–∑—É –±—Ä–∞–ª —Ä–∞–±–æ—á–∏–µ.
   - **–ö–∞–∫ –ø—Ä–∏–º–µ–Ω—è—Ç—å:** –ø—Ä–∞–≤–∏–º KV, –∂–¥—ë–º 10‚Äì20 —Å–µ–∫—É–Ω–¥ (kv read-through), –≤—ã–∑—ã–≤–∞–µ–º `/admin/diag?q=ai-queue`. –î–æ–ª–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è `endpoints.activeBaseUrl` –∏ `sources.baseUrls:"kv"`. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç –≤ runbook —Å –ø—Ä–∏—á–∏–Ω–æ–π.

### –û–±—â–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–∞–≤–∫–∏ KV

1. –°—á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â–∏–π JSON: `wrangler kv key get --binding AI_CONTROL_KV AI_QUEUE_CONFIG`.
2. –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ, —Å–æ–±–ª—é–¥–∞—è —Ñ–æ—Ä–º–∞—Ç (–≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤).
3. –ó–∞–≥—Ä—É–∑–∏—Ç—å: `wrangler kv key put --binding AI_CONTROL_KV AI_QUEUE_CONFIG --path ./ai-queue-config.json`.
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/admin/diag?q=ai-queue` –∏ tail –ª–æ–≥–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ `[ai][config]` —Å –Ω–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
5. –°–ª–µ–¥–∏—Ç—å –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏: `avgWaitMs`, `droppedSinceBoot`, `[ai][timeout]`, `[ai][retry]`, `failoverCounts`. –ï—Å–ª–∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —É—Ö—É–¥—à–∏–ª–æ—Å—å, –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–æ—à–ª–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–¥–µ—Ä–∂–∏—Ç–µ –±—ç–∫–∞–ø JSON).

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö

- **OpenAI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–ª–æ—à–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –∏–ª–∏ 5xx:**
  1. –í KV —Å—Ç–∞–≤–∏–º `"AI_BASE_URLS"` —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä–∞–±–æ—á–∏–π —Ä–µ–≥–∏–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"https://api.openai.com/v1/responses?cf_region=eu"`).
  2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `"AI_ENDPOINT_FAILOVER_THRESHOLD": 1`, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.
  3. –ü–æ–Ω–∏–∂–∞–µ–º `"AI_MAX_CONCURRENCY": 2`, —á—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å –¥–∞–≤–ª–µ–Ω–∏–µ –∏ –Ω–µ —É–ª–µ—Ç–µ—Ç—å –≤ –ª–∏–º–∏—Ç—ã Cloudflare.
  4. –û–∂–∏–¥–∞–µ–º `[ai][failover]` –≤ –ª–æ–≥–∞—Ö –∏ `endpoints.activeBaseUrl` ‚Üí –Ω–æ–≤—ã–π URL.

- **–û—á–µ—Ä–µ–¥—å –¥—Ä–æ–ø–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã (`droppedSinceBoot` —Ä–∞—Å—Ç—ë—Ç):**
  1. –£–≤–µ–ª–∏—á–∏—Ç—å `AI_QUEUE_MAX_SIZE` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ 96) –∏/–∏–ª–∏ `AI_MAX_CONCURRENCY` (–¥–æ 6‚Äì8), –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ OpenAI –æ—Ç–≤–µ—á–∞–µ—Ç —à—Ç–∞—Ç–Ω–æ.
  2. –ü–æ—Å–ª–µ –ø—Ä–∞–≤–∫–∏ KV —Å—Ä–∞–≤–Ω–∏—Ç—å `queued`, `avgWaitMs`, `droppedSinceBoot`. –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —É–ª—É—á—à–µ–Ω–∏–π –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Ü–∏—Ñ—Ä–∞–º –∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞.

- **–†–µ—Ç—Ä–∞–∏ –Ω–µ –ø–æ–º–æ–≥–∞—é—Ç, —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞—é—Ç:**
  1. –°–Ω–∏–∑–∏—Ç—å `AI_RETRY_MAX` –¥–æ 1‚Äì2, —á—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞—Ç—å —Å–ª–æ—Ç—ã –ø—É—Å—Ç—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏.
  2. –£–∫–æ—Ä–æ—Ç–∏—Ç—å `AI_TIMEOUT_MS` –¥–æ 12_000, —á—Ç–æ–±—ã –≤–æ—Ä–∫–µ—Ä –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏–∑–Ω–∞–≤–∞–ª –æ—à–∏–±–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–µ–∞–∫—Ü–∏—é.
  3. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É: –≤–Ω–µ—à–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç ¬´–Ø –Ω–∞ —Å–µ–∫—É–Ω–¥—É –æ—Ç–≤–ª–µ–∫—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â—ë —Ä–∞–∑ üîÅüí¨¬ª, –∞ –≤ –ª–æ–≥–∞—Ö ‚Äî `[ai][timeout]` + `[ai][retry] attempt=1`.

–ü—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ JSON –≤ change-log –∏ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ —Å–Ω–∏–º–æ–∫ `/admin/diag?q=ai-queue` (–¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ source=`kv`). –≠—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –¥–æ—Ä–æ–∂–Ω–æ–π –∫–∞—Ä—Ç–µ M8 Backpressure.

`AI_QUEUE_CONFIG` –∂–∏–≤—ë—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º KV namespace `AI_CONTROL_KV`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–ø–∏—Å–∞–Ω –∫–∞–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –±–∏–Ω–¥–∏–Ω–≥ –≤–æ—Ä–∫–µ—Ä–∞ –≤ `wrangler.toml`. –≠—Ç–æ –Ω–µ ¬´–µ—â—ë –æ–¥–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è¬ª, –∞ –≤–Ω–µ—à–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –ø—Ä–æ–¥–æ–≤–æ–≥–æ –ª–∏–º–∏—Ç–µ—Ä–∞: JSON –≤ —ç—Ç–æ–º KV –∑–∞–¥–∞—ë—Ç –ª–∏–º–∏—Ç—ã –æ—á–µ—Ä–µ–¥–∏, —Ç–∞–π–º–∞—É—Ç—ã, —á–∏—Å–ª–æ —Ä–µ—Ç—Ä–∞–µ–≤ –∏ —Å–ø–∏—Å–æ–∫ –±–∞–∑–æ–≤—ã—Ö OpenAI endpoints, –ø—Ä–∏—á—ë–º –≤–æ—Ä–∫–µ—Ä —á–∏—Ç–∞–µ—Ç –µ–≥–æ –ø–µ—Ä–≤—ã–º, –∑–∞—Ç–µ–º fallback‚Äô–∏—Ç—Å—è –Ω–∞ ENV –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∞ –¥–µ—Ñ–æ–ª—Ç—ã –≤ –∫–æ–¥–µ. –¢–∞–∫–æ–π –ø–æ—Ä—è–¥–æ–∫ –∂—ë—Å—Ç–∫–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤ –ø–∞–º—è—Ç–∫–µ –ø–æ M8 Backpressure –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º –º–µ–Ω—è—Ç—å –ª–∏–º–∏—Ç—ã –±–µ–∑ –¥–µ–ø–ª–æ—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –ø–æ–¥–Ω—è—Ç—å –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å `AI_BASE_URLS` –ø—Ä–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ OpenAI.

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `apps/worker-main/index.ts` –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–µ—Ç, —á—Ç–æ –≤–æ—Ä–∫–µ—Ä –∏–º–µ–Ω–Ω–æ —á–∏—Ç–∞–µ—Ç `AI_QUEUE_CONFIG` –∏–∑ `AI_CONTROL_KV`, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç JSON –∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç, –ø—Ä–∏—à—ë–ª –ª–∏ –æ–Ω –∏–∑ KV, ENV –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–æ–≤. –≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤ –∫–æ–¥–µ: binding –¥–∞—ë—Ç –Ω–∞–º hot-reload –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ, —Ç–æ–≥–¥–∞ –∫–∞–∫ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JSON –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª –±—ã –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –∏ –¥–µ–ø–ª–æ—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø—Ä–∞–≤–∫–µ (—á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç–æ–≤ –∏ –æ—Ç–∫–ª–∏–∫–æ–≤ –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã).

–ê–¥–º–∏–Ω—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ `/admin/diag?q=ai-queue` –∫–∞–∫ —Ä–∞–∑ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–ª–æ–∫ `sources`, —á—Ç–æ–±—ã –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏–∫–∏ –≤–∏–¥–µ–ª–∏, —á—Ç–æ –ª–∏–º–∏—Ç—ã —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–∏—à–ª–∏ –∏–∑ `AI_CONTROL_KV`, –∏ –º–æ–≥–ª–∏ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –ø–æ–¥–∫—Ä—É—Ç–∏—Ç—å KV-–∑–∞–ø–∏—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–≤–µ–ª–∏—á–∏—Ç—å `maxConcurrency` –∏–ª–∏ —Ä–∞—Å–ø–∏—Å–∞—Ç—å failover) –±–µ–∑ —É—á–∞—Å—Ç–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤. –≠—Ç–æ –æ–¥–Ω–∞ –∏–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ—Ä–æ–∂–Ω–æ–π –∫–∞—Ä—Ç—ã (—à–∞–≥ 4.4) –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è —Å—Ç—Ä–µ—Å—Å-–ø—Ä–æ–≥–æ–Ω–æ–≤ –æ—á–µ—Ä–µ–¥–∏ ‚Äî –¥–µ—Ñ–æ–ª—Ç—ã –≤ –∫–æ–¥–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –Ω–∞ –ø—Ä–æ–¥–µ.

–û—Ç–≤–µ—á–∞—è –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å: —Å–∞–º –≤–æ—Ä–∫–µ—Ä –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ `AI_QUEUE_CONFIG` ‚Äî –æ–Ω —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞–µ—Ç –µ–≥–æ. –ù–æ –∑–∞–ø–∏—Å—å —Ç—É–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è —Å—Ç–æ–ª—å–∫–æ —Ä–∞–∑, —Å–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ: –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ —Å–º—è–≥—á–∏—Ç—å backpressure, –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π OpenAI endpoint –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥ failover, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å JSON –≤ KV. –î–µ–ª–∞—Ç—å —ç—Ç–æ —á–µ—Ä–µ–∑ plain ENV –∏–ª–∏ –ø—Ä–æ—à–∏—Ç—ã–π –≤ –∫–æ–¥–µ —Ñ–∞–π–ª –Ω–µ–ª—å–∑—è, –ø–æ—Ç–æ–º—É —á—Ç–æ (–∞) plaintext ENV –≤ Cloudflare —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –¥–µ–ø–ª–æ–µ–º –∏ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫, (–±) –∫–æ–¥–æ–≤—ã–π JSON –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª –±—ã –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –∏ –æ—Ç–∫–∞—Ç–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ. KV-binding —Ä–µ—à–∞–µ—Ç –æ–±–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ñ–∏–≥ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ.
