# MANUAL

## Конфиг AI_QUEUE_CONFIG (лимиты очереди, таймауты, ретраи и маршрутизация OpenAI)
## Ответ
`AI_QUEUE_CONFIG` живёт в отдельном KV namespace `AI_CONTROL_KV`, который прописан как обязательный биндинг воркера в `wrangler.toml`. Это не «ещё одна переменная», а внешний источник правды для продового лимитера: JSON в этом KV задаёт лимиты очереди, таймауты, число ретраев и список базовых OpenAI endpoints, причём воркер читает его первым, затем fallback’ится на ENV и только после этого на дефолты в коде. Такой порядок жёстко задокументирован в памятке по M8 Backpressure и позволяет операторам менять лимиты без деплоя, например, чтобы поднять пропускную способность или переключить `AI_BASE_URLS` при деградации конкретного региона OpenAI.

Реализация в `apps/worker-main/index.ts` подчёркивает, что воркер именно читает `AI_QUEUE_CONFIG` из `AI_CONTROL_KV`, валидирует JSON и для каждого параметра фиксирует, пришёл ли он из KV, ENV или дефолтов. Это не просто переменная в коде: binding даёт нам hot-reload конфигурации в рантайме, тогда как встроенный JSON потребовал бы пересборки и деплоя при каждой правке (что критично для стресс-тестов и откликов на инциденты).

Админская диагностика `/admin/diag?q=ai-queue` как раз показывает блок `sources`, чтобы оперативники видели, что лимиты реально пришли из `AI_CONTROL_KV`, и могли в любой момент подкрутить KV-запись (например, увеличить `maxConcurrency` или расписать failover) без участия разработчиков. Это одна из проверок дорожной карты (шаг 4.4) и обязательный критерий для стресс-прогонов очереди — дефолты в коде не должны оставаться источником на проде.

Отвечая на последний вопрос: сам воркер ничего не записывает в `AI_QUEUE_CONFIG` — он только читает его. Но запись туда действительно может меняться столько раз, сколько потребуется эксплуатационной команде: когда нужно быстро смягчить backpressure, добавить новый OpenAI endpoint или изменить порог failover, достаточно обновить JSON в KV. Делать это через plain ENV или прошитый в коде файл нельзя, потому что (а) plaintext ENV в Cloudflare синхронизируются деплоем и не предназначены для частых оперативных правок, (б) кодовый JSON потребовал бы пересборки и отката при каждом эксперименте. KV-binding решает обе проблемы и держит конфиг централизованно.

## Testing
⚠️ Тесты не запускались (режим read-only QA).

## Отчёт
Коммиты: нет.
