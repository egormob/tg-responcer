# Архитектурный обзор tg-responcer

## Входная точка Cloudflare Worker
- `apps/worker-main/index.ts` собирает рабочее окружение: поднимает Telegram-адаптер, OpenAI-клиент, D1-хранилище и KV-лимитер через `createPortOverrides`, а затем композитит их в `DialogEngine` посредством `composeWorker`. Здесь же включается типинг-индикатор и оповещатель о превышении лимитов, если доступен KV с суточным лимитом.【F:apps/worker-main/index.ts†L605-L668】
- `createRequestHandler` добавляет к композиции слой административных роутов, читает whitelist администраторов из KV, создаёт `determineCommandRole`, кэширует собранный роутер по версии окружения и экспортирует `fetch`-обработчик Cloudflare Worker.【F:apps/worker-main/index.ts†L900-L1034】

## Порты и адаптеры
- Контракты между ядром и внешним миром определены в `apps/worker-main/ports/index.ts`: MessagingPort (typing/send/edit/delete), AiPort, StoragePort и RateLimitPort. Порты описывают ретраи, требования к идентификаторам и деградацию (например, MessagingPort обязан проглатывать recoverable-ошибки typing-индикатора, а RateLimitPort «пропускает» пользователя при деградации).【F:apps/worker-main/ports/index.ts†L11-L205】
- Адаптеры (`adapters/telegram`, `adapters/openai-responses`, `adapters/d1-storage`, `adapters/kv-rate-limit`) реализуют эти контракты; выбор конкретных адаптеров выполняет `createPortOverrides`, включая динамическое чтение лимита/окна из ENV и инициализацию OpenAI с failover-базами URL, таймаутом и ретраями из AI control KV.【F:apps/worker-main/index.ts†L605-L642】

## Диалоговый контур с лимитером и «фолловером»
- `DialogEngine` (ядро) первым делом вызывает `rateLimit.checkAndIncrement`. Если лимит исчерпан, верхний уровень получает `status: 'rate_limited'` и может уведомить пользователя заранее установленным текстом. При положительном ответе запускается `messaging.sendTyping` — это и есть «фолловер» пользователя (поддержание ожидания).【F:apps/worker-main/core/DialogEngine.ts†L64-L90】
- Параллельно сохраняется профиль пользователя и сообщение, а затем достаётся хвост истории для контекста модели. Ошибки отдельных операций выбрасываются наружу, что объясняет, почему деградация любой из подсистем полностью прерывает цикл ответа. После ожидания typing-индикатора вызывается `ai.reply`; если очередь перегружена и выбрасывает `AI_QUEUE_TIMEOUT/DROPPED`, ядро шлёт дружественное сообщение из `getFriendlyOverloadMessage` и продолжает цикл, фиксируя факт деградации в metadata.【F:apps/worker-main/core/DialogEngine.ts†L108-L191】
- Финальная фаза — `messaging.sendText`, append assistant message и возврат `status: 'replied'`. Typing-индикатор обязателен к завершению даже при ошибках (`finally`-блок) — иначе Telegram может «зависнуть» на typing без ответа.【F:apps/worker-main/core/DialogEngine.ts†L176-L212】
- Дополнительные элементы контура: `createRateLimitToggle` оборачивает RateLimitPort и позволяет выключить ограничения через флаг `LIMITS_ENABLED`; при ошибке чтения флага система безопасно разрешает все сообщения и логирует предупреждение, чтобы не блокировать диалог из-за KV. Это потенциальная точка «размыкания петли» лимита, о которой нужно помнить при расследовании перегрузок.【F:apps/worker-main/features/limits/rate-limit-toggle.ts†L20-L132】

## HTTP-слой и маршрутизация
- `createRouter` обслуживает `/healthz`, административные эндпоинты и сам Telegram webhook. Он проверяет секрет вебхука, парсит update, вызывает `transformPayload`, логирует снимки идентификаторов и маршрутов, а затем решает: это системная команда, non-text или обычное сообщение. Стандартные команды `/start` и `/admin` обслуживаются предустановленными хендлерами, остальные делегируются наверх. Любые ошибки трансформации возвращают 400, а не падают с 500, что упрощает диагностику некорректных payload-ов.【F:apps/worker-main/http/router.ts†L360-L561】
- Системные команды отлавливаются через `matchSystemCommand`. При несовпадении роли (например, `/admin` без полномочий) роутер логирует `system command role mismatch`, отправляет typing и информирует пользователя сообщением `ADMIN_ROLE_MISMATCH_TEXT`. Это как раз тот сценарий, который наблюдается в приложенном логе: команда распознана, но не прошла проверку роли, значит цепочка регистрации/авторизации админа где-то разорвана.【F:apps/worker-main/http/router.ts†L563-L626】
- Для обычных сообщений роутер вызывает `DialogEngine`. Если ядро вернуло `rate_limited`, срабатывает `RATE_LIMIT_FALLBACK_TEXT` и опциональный `rateLimitNotifier`, который пишет пользователю подсказку из заранее заданного канала (через MessagingPort). Подробная последовательность, инструкции по воспроизведению и артефакты (лог + скрин) собраны в `docs/operations/rate-limits.md`.【F:apps/worker-main/http/router.ts†L232-L334】

## Системные команды и роли
- Реестр команд (`http/system-commands`) заранее знает допустимые команды и их роли (`global` или `scoped`). Глобальные команды автоматически разрешаются для всех, scoped — только после регистрации конкретного пользователя через `registry.register`. Регистрация происходит в `createTelegramWebhookHandler`: когда обработчик админ-команды успешно завершился (или явно подтвердил команду), вызывается `onSystemCommand`, который пробрасывает userId в реестр. Только после этого `registry.isAllowed` начнёт возвращать `true` для пары (команда, пользователь).【F:apps/worker-main/http/system-commands/index.ts†L3-L191】【F:apps/worker-main/features/utm-tracking/create-telegram-webhook-handler.ts†L126-L185】【F:apps/worker-main/http/telegram-webhook.ts†L563-L590】
- Проверка роли в рантайме выполняется функцией `determineCommandRole`, которую `createRequestHandler` строит поверх `adminAccess`. Если KV с whitelist недоступен, `adminAccess` возвращает `false`, и даже зарегистрированная команда перейдёт в ветку `role_mismatch`. Это объясняет, почему отсутствие ответов администратору сопровождается ровно этим логом: либо ID не попал в whitelist, либо кэш whitelist (30 секунд по умолчанию) устарел/невалидирован и не подхватывает новые значения.【F:apps/worker-main/features/admin-access/admin-access.ts†L13-L87】【F:apps/worker-main/index.ts†L907-L917】

## Фичи и вспомогательные подсистемы
- UTM-трекинг (`features/utm-tracking/create-telegram-webhook-handler.ts`) оборачивает `transformTelegramUpdate`, ведёт кэш известных пользователей, автоматически подставляет `utmSource` в профиль и умеет асинхронно сохранять данные через StoragePort. Он же предоставляет `knownUsers` для административного API очистки кэша — важная связка, чтобы не «застревали» устаревшие UTM-метки.【F:apps/worker-main/features/utm-tracking/create-telegram-webhook-handler.ts†L1-L220】
- Административные фичи (`features/admin-diagnostics`, `features/export`, `features/broadcast`) интегрируются внутри `createTransformPayload` и `createAdminRoutes`: на уровне Telegram команд формируются обработчики `/admin ...`, `/export`, `/broadcast`, а на уровне HTTP открываются защищённые токеном эндпоинты для self-test, envz, диагностики биндингов, выгрузки CSV и мгновенных рассылок. Эти компоненты используют общий `AdminCommandErrorRecorder`, чтобы записывать сбои в KV и иметь возможность последующей ревизии.【F:apps/worker-main/index.ts†L686-L899】

## Петли обратной связи и потенциальные конфликтные точки
1. **Регистрация команд ↔ проверка роли.** Чтобы админ-команда прошла, должны выполниться обе части цепочки: успешный вызов `handleAdminCommand` (который вызовет `onSystemCommand`) и положительный ответ `adminAccess.isAdmin`. Любой разрыв приводит к `system_command_role_mismatch`, typing-индикатору и сообщению об отсутствии прав. Проверять стоит как KV `ADMIN_TG_IDS`, так и код возврата админ-хендлеров (должны подтверждать `confirmSystemCommand`), иначе пользователь никогда не попадёт в реестр.【F:apps/worker-main/http/router.ts†L563-L626】【F:apps/worker-main/http/telegram-webhook.ts†L563-L590】
2. **Лимиты ↔ уведомления ↔ тумблер.** RateLimitPort сначала может быть отключён `createRateLimitToggle`, а затем, даже при срабатывании, `rateLimitNotifier` может параллельно отправить вспомогательное сообщение, используя тот же MessagingPort, что и основной ответ. Если notifier активен, нужно следить, чтобы дополнительные отправки не усугубляли ограничения Telegram (особенно при массовом исчерпании лимита).【F:apps/worker-main/index.ts†L650-L667】【F:apps/worker-main/features/limits/rate-limit-toggle.ts†L20-L132】
3. **UTM-кэш ↔ StoragePort.** Кэш известных пользователей живёт в оперативной памяти воркера и синхронизируется лениво через `storage.saveUser` (с `waitUntil`). При сбоях StoragePort кэш всё равно будет содержать новую UTM-метку, что может дать рассогласование между аналитикой и фактической базой. Это особенно критично при ручной очистке кэша через `/admin knownUsersClear`: очистка сбрасывает только локальную структуру, поэтому важно логировать успех `saveUser` для выявления расхождений.【F:apps/worker-main/features/utm-tracking/create-telegram-webhook-handler.ts†L160-L220】
4. **Очередь ИИ ↔ «дружелюбный» ответ.** При таймауте очереди `DialogEngine` падает в деградированный режим, но всё равно отправляет сообщение и сохраняет его в историю. Это означает, что пользователи получат два разных поведения в зависимости от нагрузки, и если администратор тестирует бота в момент перегрузки, он увидит корректный фолбэк и может решить, что всё в порядке, хотя реальные пользователи уже получили ошибки. Контроль за `AI_QUEUE_CONFIG` и маршрутом `/admin/diag?q=ai-queue` обязателен, чтобы быстро увидеть дисбаланс между `maxConcurrency` и входящими запросами.【F:apps/worker-main/core/DialogEngine.ts†L136-L191】【F:apps/worker-main/index.ts†L698-L735】

## Практические шаги для текущей проблемы с админом
- Проверить, что KV `ADMIN_TG_IDS` содержит ID администратора в текстовом JSON (`{"whitelist":["<id>"]}`) и что TTL кэша (`ADMIN_ACCESS_CACHE_TTL_MS`) не мешает подхватить изменения. При необходимости вызвать `adminAccess.invalidate()` через `GET /admin/access?invalidate=all` или временно установить TTL в 0, чтобы каждый запрос читал KV напрямую.【F:apps/worker-main/features/admin-access/admin-access.ts†L13-L87】【F:apps/worker-main/features/admin-access/diagnostics-route.ts†L1-L154】
- Убедиться, что обработчики `/admin` и `/export` действительно возвращают `Response` или объект с `confirmSystemCommand: true` при корректном использовании; иначе `createTelegramWebhookHandler` не зарегистрирует команду и реестр останется пустым для конкретного пользователя.【F:apps/worker-main/http/telegram-webhook.ts†L563-L590】
- Если админские сообщения продолжают попадать в `system_command_role_mismatch`, стоит добавить временный лог `adminAccess.isAdmin` и `systemCommands.isAllowed` внутри `determineCommandRole` (вне ядра) — это позволит увидеть, какая из петель (регистрация или whitelist) разорвана, не трогая FROZEN core.

## Согласование архитектуры с дорожной картой (26.11.2025)
- **Дорожная карта закрыта без хвостов.** Все шаги RoadMap переведены в `✅`, статусы M5–M9 ссылаются на журналы `memory-bank/diagnostics.md`, новый отчёт [memory-bank/logs/m9-ai-export-timeout-2025-11-26.md](../../memory-bank/logs/m9-ai-export-timeout-2025-11-26.md) и актуализированную версию `RoadMap.md` c прямыми ссылками на артефакты.
- **Админский и пользовательский контуры стабильны.** После очистки кулдауна KV ([memory-bank/logs/rate-limit-kv-2025-11-26.md](../../memory-bank/logs/rate-limit-kv-2025-11-26.md)) whitelisted администратор подтверждён логами переписки ([memory-bank/logs/telegram-admin-recovery-2025-11-26.md](../../memory-bank/logs/telegram-admin-recovery-2025-11-26.md)) и tail-сессией ([memory-bank/logs/wrangler-tail-admin-2025-11-26.md](../../memory-bank/logs/wrangler-tail-admin-2025-11-26.md)); обычные пользователи удерживают `droppedSinceBoot=0` по smoke-прогону очереди ([memory-bank/logs/ai-queue-smoke-2025-11-16.md](../../memory-bank/logs/ai-queue-smoke-2025-11-16.md)).
- **Лимиты и AI-очередь синхронизированы.** Variant C описан в [reports/REPORT-ai-throughput-20251116.md](../../reports/REPORT-ai-throughput-20251116.md); `/admin status` возвращает те же `aiQueue` показатели, что и `memory-bank/logs/m9-ai-export-timeout-2025-11-26.md`, поэтому архитектурная памятка, RoadMap и журналы дают единый источник правды для расследований.
