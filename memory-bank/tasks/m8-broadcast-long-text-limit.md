# M8 — Broadcast: обработка превышения лимита текста

- Версия: 2025-11-24
- Статус: ⏳ открыто

## Контекст
Админская рассылка ломается при отправке текста длиннее лимита (лог e7b962b1). Telegram делит сообщение на две части, бот принимает обе, но:
1. Показывает неверный хвост: фиксированное сообщение про «сократите на 124 символа», хотя фактический остаток зависит от второго сообщения.
2. Вторую часть Telegram-сообщения бот воспринимает как валидный текст и запускает рассылку, игнорируя факт превышения лимита.
3. Итог: рассылка уходит с усечённым или невалидным текстом без явной отмены/повторного ввода.

## Цель
Заблокировать рассылку при первом получении текста длиннее лимита и потребовать явной команды `/new_text` или `/cancel` перед любыми дальнейшими действиями. Игнорировать все сообщения до одной из этих команд, чтобы хвосты Telegram не попадали в рассылку.

## Требования реализации
1. **Блокировка после превышения лимита.** При получении текста > лимита бот отвечает: «Текст рассылки не укладывается в лимит на N символов. Нажмите /new_text чтобы отправить новый или отмените рассылку /cancel.» Где N = `length - limit` с учётом всех частей сообщения.
2. **Игнорирование хвостов.** Все входящие сообщения после превышения лимита должны игнорироваться до команды `/new_text` или `/cancel`. Никаких автоматических переходов в «awaiting text» без явной команды.
3. **Команда `/cancel`.** Сбрасывает рассылку, возвращает меню как `/admin`, очищает временное состояние превышения.
4. **Команда `/new_text`.** Сбрасывает превышение, переводит в режим «ожидаем текст» с подсказкой про максимальную длину.
5. **Повторные превышения.** Если новый текст снова превышает лимит, цикл начинается заново с блокировкой и игнором хвостов.
6. **Логирование.** Логи должны фиксировать факт блокировки (reason `too_long_blocked` или аналог), длину текста и то, что хвосты были проигнорированы.

## План задач
### Задача 1: Изоляция состояния «превышение лимита»
- Добавить явное состояние сценария рассылки «blocked_too_long» (или флаг) после первой попытки отправки текста > лимита.
- При этом сохранить информацию о размере превышения (`length`, `limit`, `overflow`), чтобы корректно показать N.
- Документировать переходы состояний, чтобы хвосты из Telegram не обрабатывались.
- **Проверки после задачи 1:** модульная/интеграционная проверка, что при превышении лимита ответ содержит корректное N и что повторные сообщения до `/new_text`/`/cancel` игнорируются (можно эмулировать два подряд `update` с кусками текста).
- **Данные для лога/журнала:** сохранить примеры входящих апдейтов (два куска текста > лимита) и ожидаемый ответ/состояние.

### Задача 2: Команды восстановления (`/new_text` и `/cancel`)
- Реализовать обработку `/new_text` и `/cancel` из состояния «blocked_too_long».
- `/cancel`: сброс всех полей рассылки, возврат в стандартное меню администратора, лог о сбросе.
- `/new_text`: сброс блока, перевод в режим ожидания текста с подсказкой про максимальную длину.
- **Проверки после задачи 2:** сценарный тест: `/broadcast` → `/everybody` → текст > лимита → хвост → `/new_text` → валидный текст ≤ лимита → подтверждение, что рассылка стартует только после валидного текста. Отдельно: `/cancel` после блока возвращает меню и не запускает рассылку.
- **Данные для лога/журнала:** tail-лог с шагами сценария, фиксация переходов состояний, запись о сбросе/новом вводе.

### Задача 3 (опционально, если потребуется): Корректное вычисление N и покрытие регрессиями
- Пересчитать N как `totalLength - limit` для всего собранного текста (включая склеенные части Telegram), избегая магического числа 124.
- Добавить регрессионные тесты для длинных сообщений (разные длины, 1–3 части, Unicode).
- **Проверки после задачи 3:** автоматизированный тест-сьют для broadcast, ручной smoke: отправка 1. ровно в лимите, 2. +1 символ, 3. сильно выше лимита (две части). Проверить, что хвосты игнорируются и N совпадает с фактическим превышением.
- **Данные для лога/журнала:** ссылки на тестовые артефакты и фиксация N в ответах бота.

## Ожидаемые артефакты
- Обновлённые логи/снимки tail для сценариев превышения лимита.
- Ссылки на коммиты/PR с реализацией каждой задачи.
- Запись в журнал проверок (memory-bank/tests или logs) о прогоне сценариев из задач 1–3.
