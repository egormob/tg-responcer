# Module Isolation Audit (Milestone 1 · Step 2)

## Краткий итог
- Проверены заготовки фич и адаптеров, не задействованных в активной цепочке.
- Прямых зависимостей от `adapters/openai-responses` и `assistantId` вне активного контура не обнаружено.
- Блокирующих рисков не найдено; зафиксированы наблюдаемые точки для будущих фич.

## Проверенные модули

### `apps/worker-main/features/limits`
- `rate-limit-notifier.ts` и `rate-limit-toggle.ts` используют только `MessagingPort` и `RateLimitPort`, внешний доступ к Responses отсутствует.
- Флаговые значения читаются из KV (`LimitsFlagKvNamespace`), подключение происходит через `composition/compose.ts` только при наличии биндинга.

### `apps/worker-main/features/export`
- `admin-export-route.ts` проверяет токен и проксирует запрос в предоставленный `handleExport` без привязки к AI.
- `csv-export.ts` ограничивается чтением из D1 (`db.prepare`) и форматированием CSV; отсутствуют импорты Telegram/AI.

### `apps/worker-main/features/admin-diagnostics`
- `self-test-route.ts` опирается на `AiPort` и работает только по защищённому админ-роуту, исключая побочные вызовы из пользовательского контура.
- `envz-route.ts` валидирует переменные окружения и не обращается к Responses напрямую.

### `apps/worker-main/features/broadcast`
- `admin-broadcast-route.ts` проверяет токены и валидирует JSON без обращений к AI или Telegram.
- `broadcast-queue.ts` хранит задания в памяти и не импортирует внешние адаптеры, что гарантирует изоляцию от активного диалогового контура.

### `apps/worker-main/adapters-noop`
- `createNoopPorts` возвращает безопасные заглушки, которые логируют обращения и не инициируют внешние вызовы.
- Заглушки применяются в `composeWorker` как fallback и не модифицируют состояние активных адаптеров.

### `apps/worker-main/composition/compose.ts`
- Подключает `createRateLimitToggle` только при наличии `RATE_LIMIT_KV`, иначе сохраняет чистый порт.
- Не активирует дополнительные фичи, если адаптеры не переданы явно; базовые порты остаются NOOP.

### Тесты и вспомогательные файлы
- `rg "assistantId"` показывает упоминания только в документации (`RoadMap.md`, `memory-bank/openai-responses-prompt.md`).
- Юнит-тесты фич и адаптеров используют локальные моки, не импортируют `adapters/openai-responses`.

## Выявленные наблюдения
- Для запуска рассылок потребуется планировщик (М8.Ш2); важно сохранить отсутствие прямых обращений к AI и Messaging внутри очереди.
- При подключении реальных адаптеров D1/KV стоит добавить smoke-тесты маршрутов экспорта и лимитов.

## Рекомендации
- Поддерживать документ в актуальном состоянии при добавлении новых фич или адаптеров.
- При обнаружении зависимостей, влияющих на активную цепочку, оформлять «Задачу-торможение» и фиксировать ссылку в RoadMap.
