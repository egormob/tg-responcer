# План внешней проверки `/admin/export`

## Цель
Подтвердить, что администратор может получить корректный CSV-экспорт диалогов через Cloudflare Worker, и что эндпоинт защищён токеном.

## Предпосылки
- Задеплоенный воркер с актуальной версией `apps/worker-main`.
- Настроенный секрет `ADMIN_TOKEN` (используется в заголовке `X-Admin-Token`).
- База D1 заполнена тестовыми данными (минимум 3 пользователя, по 2 сообщения).
- Воркерам разрешено выполнять запросы `fetch` к D1, KV и Responses (как в прод-конфигурации).

## Шаги проверки
1. **Подготовка окружения**
   - Зафиксировать URL воркера: `https://<worker-host>/admin/export`.
   - Подготовить диапазон дат (например, `from` — 7 дней назад, `to` — текущее время) и пагинацию `limit=100`.
   - Открыть консоль для логов `wrangler tail --format=pretty`.
2. **Позитивный сценарий**
   - Выполнить запрос:
     ```bash
     curl -H "X-Admin-Token: $ADMIN_TOKEN" \
       "https://<worker-host>/admin/export?from=2025-10-01T00:00:00Z&to=2025-10-31T23:59:59Z&limit=100"
     ```
   - Убедиться, что HTTP-статус `200`.
   - Проверить заголовки ответа:
     - `Content-Type: text/csv; charset=utf-8`
     - `Content-Disposition` с именем файла `dialog-export-<timestamp>.csv`
     - `Cache-Control: no-store`
   - Открыть файл в текстовом редакторе или Excel и подтвердить:
     - Наличие UTF-8 BOM.
     - Структуру колонок: `timestamp,user_id,username,role,message`.
     - Экранирование кавычек и запятых.
3. **Негативные сценарии**
   - Повторить запрос без заголовка `X-Admin-Token` — ожидать статус `401`.
   - Выполнить запрос с `limit=1000` — ожидать `400` и сообщение об ограничении.
   - Проверить, что при `from > to` возвращается `400` с описанием ошибки.
4. **Проверка пагинации**
   - Создать запрос с `cursor=<значение из предыдущего ответа>` и убедиться, что возвращается следующая страница, пока данные не закончатся.
5. **Логирование**
   - На `wrangler tail` убедиться, что
     - Запросы логируются с `requestId`.
     - Ошибки авторизации/валидации помечаются уровнем `warn`.
6. **Артефакты проверки**
   - Сохранить успешный CSV в `snapshot/admin-export/<date>/export.csv` (вне git).
   - Зафиксировать команду и результат в журнале внешних проверок.

## Ожидаемый результат
- Эндпоинт выдаёт корректный CSV, ошибки обрабатываются без падения воркера.
- Логи подтверждают успешное завершение сценариев.
- Отчёт о проверке прикладывается к `memory-bank/tests/` (по завершении).
