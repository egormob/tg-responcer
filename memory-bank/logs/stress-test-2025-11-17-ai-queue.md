# AI queue & D1 stress test — 2025-11-17

## Контур и конфигурация на момент прогона
- **Билд:** Success (Dashboard → Deployments).
- **Биндинги:** `AI_CONTROL_KV` (inherited UUID `4f72…`), `RATE_LIMIT_KV`, `DB` активны; self-test `GET /admin/selftest` → `200`.
- **Флаги:** на время теста включён `STRESS_TEST_ENABLED=1` (вернули `0` после прогонов).
- **Rate-limit KV:** персональный `freeze` ключ изменён вручную (`limit=1` вместо `50`), возможны остаточные ключи.

## Диагностика `/admin/diag?q=ai-queue`
| Время | active | queued | droppedSinceBoot | avgWaitMs | maxConcurrency | maxQueue | Комментарий |
| --- | --- | --- | --- | --- | --- | --- | --- |
| До теста | 0 | 0 | 0 | 0 | 4 | 64 | Значения совпадают с дефолтами. |
| Во время нагрузки | 0 | 0 | 0 | 0 | 4 | 64 | KV-оверрайды (`AI_CONTROL_KV` 3/25) не применились. |
| После теста | 0 | 0 | 0 | 0 | 4 | 64 | Очередь пуста, дропов нет. |

## Поведение в чате
- Ответы шли стабильно, TTFB без скачков.
- Периодически показывался мягкий overload-месседж «Перегружены запросами…» — сработал лимитер очереди, а не OpenAI.

## Логи (Observability)
- `[ai][config]` зафиксирован, таймаутов и дропов AI не найдено.
- В блоке D1 стресс-ручки последовательно видны события: `saveUser/appendMessage failed, retrying` → `exhausted retries` → `[d1-stress][max_retries_exceeded] ops=saveUser attempts=6` (≈17:47:2x–17:47:4x UTC). Скриншот сохранён вне репозитория.

## Выводы по слоям
- **AI-очередь:** PASS. Очередь пуста, дропов нет. Конкурентность/размер взяты из дефолта (4/64), в рантайме игнорируются KV-override (`AI_QUEUE_CONFIG`). Требуется сверка ключей внутри `AI_CONTROL_KV`.
- **D1 под нагрузкой:** FAIL. Стресс-ручка упёрлась в `max_retries_exceeded`. Нужны правки ретраев/джиттера в стресс-ручке или снижение её параллелизма. Боевой контур не трогаем.

## Follow-up
1. Проверить соответствие ключей `AI_CONTROL_KV` ↔ рантайм-конфиг (подтвердить поддержку `AI_QUEUE_CONFIG`).
2. Подготовить таск по стабилизации `d1-stress` (адаптивный бэкофф/джиттер, ограничение concurrency) перед повторным прогонами.
3. После фикса повторить стресс-тест с фиксацией `/admin/diag?q=ai-queue` и логов D1.
