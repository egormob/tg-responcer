# AI queue & D1 stress test ‚Äî 2025-11-17

## –ö–æ–Ω—Ç—É—Ä –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ –º–æ–º–µ–Ω—Ç –ø—Ä–æ–≥–æ–Ω–∞
- **–ë–∏–ª–¥:** Success (Dashboard ‚Üí Deployments).
- **–ë–∏–Ω–¥–∏–Ω–≥–∏:** `AI_CONTROL_KV` (inherited UUID `4f72‚Ä¶`), `RATE_LIMIT_KV`, `DB` –∞–∫—Ç–∏–≤–Ω—ã; self-test `GET /admin/selftest` ‚Üí `200`.
- **–§–ª–∞–≥–∏:** –Ω–∞ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ –≤–∫–ª—é—á—ë–Ω `STRESS_TEST_ENABLED=1` (–≤–µ—Ä–Ω—É–ª–∏ `0` –ø–æ—Å–ª–µ –ø—Ä–æ–≥–æ–Ω–æ–≤).
- **Rate-limit KV:** –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π `freeze` –∫–ª—é—á –∏–∑–º–µ–Ω—ë–Ω –≤—Ä—É—á–Ω—É—é (`limit=1` –≤–º–µ—Å—Ç–æ `50`), –≤–æ–∑–º–æ–∂–Ω—ã –æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ –∫–ª—é—á–∏.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ `/admin/diag?q=ai-queue`
| –í—Ä–µ–º—è | active | queued | droppedSinceBoot | avgWaitMs | maxConcurrency | maxQueue | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| --- | --- | --- | --- | --- | --- | --- | --- |
| –î–æ —Ç–µ—Å—Ç–∞ | 0 | 0 | 0 | 0 | 4 | 64 | –ó–Ω–∞—á–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏. |
| –í–æ –≤—Ä–µ–º—è –Ω–∞–≥—Ä—É–∑–∫–∏ | 0 | 0 | 0 | 0 | 4 | 64 | KV-–æ–≤–µ—Ä—Ä–∞–π–¥—ã (`AI_CONTROL_KV` 3/25) –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å. |
| –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ | 0 | 0 | 0 | 0 | 4 | 64 | –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞, –¥—Ä–æ–ø–æ–≤ –Ω–µ—Ç. |

## –ü–æ–≤–µ–¥–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
- –û—Ç–≤–µ—Ç—ã —à–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ, TTFB –±–µ–∑ —Å–∫–∞—á–∫–æ–≤.
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è –º—è–≥–∫–∏–π overload-–º–µ—Å—Å–µ–¥–∂ ¬´–ü–µ—Ä–µ–≥—Ä—É–∂–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–∞–º–∏‚Ä¶¬ª ‚Äî —Å—Ä–∞–±–æ—Ç–∞–ª –ª–∏–º–∏—Ç–µ—Ä –æ—á–µ—Ä–µ–¥–∏, –∞ –Ω–µ OpenAI.

## –õ–æ–≥–∏ (Observability)
- `[ai][config]` –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω, —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ –¥—Ä–æ–ø–æ–≤ AI –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
- –í –±–ª–æ–∫–µ D1 —Å—Ç—Ä–µ—Å—Å-—Ä—É—á–∫–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤–∏–¥–Ω—ã —Å–æ–±—ã—Ç–∏—è: `saveUser/appendMessage failed, retrying` ‚Üí `exhausted retries` ‚Üí `[d1-stress][max_retries_exceeded] ops=saveUser attempts=6` (‚âà17:47:2x‚Äì17:47:4x UTC). –°–∫—Ä–∏–Ω—à–æ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

## –í—ã–≤–æ–¥—ã –ø–æ —Å–ª–æ—è–º
- **AI-–æ—á–µ—Ä–µ–¥—å:** PASS. –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞, –¥—Ä–æ–ø–æ–≤ –Ω–µ—Ç. –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å/—Ä–∞–∑–º–µ—Ä –≤–∑—è—Ç—ã –∏–∑ –¥–µ—Ñ–æ–ª—Ç–∞ (4/64), –≤ —Ä–∞–Ω—Ç–∞–π–º–µ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è KV-override (`AI_QUEUE_CONFIG`). –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π –≤–Ω—É—Ç—Ä–∏ `AI_CONTROL_KV`.
- **D1 –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π:** FAIL. –°—Ç—Ä–µ—Å—Å-—Ä—É—á–∫–∞ —É–ø—ë—Ä–ª–∞—Å—å –≤ `max_retries_exceeded`. –ù—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏ —Ä–µ—Ç—Ä–∞–µ–≤/–¥–∂–∏—Ç—Ç–µ—Ä–∞ –≤ —Å—Ç—Ä–µ—Å—Å-—Ä—É—á–∫–µ –∏–ª–∏ —Å–Ω–∏–∂–µ–Ω–∏–µ –µ—ë –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞. –ë–æ–µ–≤–æ–π –∫–æ–Ω—Ç—É—Ä –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.

## Follow-up
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–ª—é—á–µ–π `AI_CONTROL_KV` ‚Üî —Ä–∞–Ω—Ç–∞–π–º-–∫–æ–Ω—Ñ–∏–≥ (–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É `AI_QUEUE_CONFIG`).
2. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–∞—Å–∫ –ø–æ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ `d1-stress` (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –±—ç–∫–æ—Ñ—Ñ/–¥–∂–∏—Ç—Ç–µ—Ä, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ concurrency) –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –ø—Ä–æ–≥–æ–Ω–∞–º–∏.
3. –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç —Å —Ñ–∏–∫—Å–∞—Ü–∏–µ–π `/admin/diag?q=ai-queue` –∏ –ª–æ–≥–æ–≤ D1.

---

## –†–µ—Ç–µ—Å—Ç 2025-11-18 ‚Äî D1 stress smoke + ai-queue snapshot

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `STRESS_TEST_ENABLED=1` –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Ä–∞–±–æ—á–µ–º –≤–æ—Ä–∫–µ—Ä–µ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º `GET /admin/d1-stress`.
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –¥–∏–∞–ª–æ–≥–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Ä—É—á–Ω–æ–π —Å–ø–∞–º).
- `wrangler tail --format=pretty` –ø–æ–∫–∞–∑—ã–≤–∞–ª –±–ª–æ–∫–∏ `[ai][config]` —Å `maxConcurrency=4`, `maxQueueSize=64`, `kvConfig:null`.

### –ù–∞–±–ª—é–¥–µ–Ω–∏—è `/admin/diag?q=ai-queue`
| –í—Ä–µ–º—è | active | queued | droppedSinceBoot | avgWaitMs | maxConcurrency | maxQueue | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| --- | --- | --- | --- | --- | --- | --- | --- |
| –î–æ —Ç–µ—Å—Ç–∞ | 0 | 0 | 0 | 0 | 4 | 64 | –ó–Ω–∞—á–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è, KV –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è. |
| –ü–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π | 1 | 0 | 0 | 0 | 4 | 64 | –ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–µ `[ai][queue_leave] active=1 queued=0 droppedSinceBoot=0`. |
| –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ | 0 | 0 | 0 | 0 | 4 | 64 | –û—á–µ—Ä–µ–¥—å –æ—á–∏—Å—Ç–∏–ª–∞—Å—å, `lastDropAt=null`. |

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ –≤ —á–∞—Ç–∞—Ö
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–ª –ø–æ–ª—É—á–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫; –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ—è–≤–∏–ª–∏—Å—å –º—è–≥–∫–∏–µ –∑–∞–≥–ª—É—à–∫–∏ `‚ö†Ô∏è ‚Üí üîÅüí¨` —É —á–∞—Å—Ç–∏ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∏ –µ–¥–∏–Ω–∏—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
- –ó–∞–≥–ª—É—à–∫–∏ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—Ç —Å `(warn) [ai][retry] reason: 'OpenAI Responses request timed out'` –∏ `(error) [ai][timeout]`; —Å–æ–±—ã—Ç–∏–π `max_retries_exceeded` –∏ `[ai][queue_drop]` –Ω–µ—Ç.
- –ü–æ—Å–ª–µ —Å–Ω—è—Ç–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç —Å–∞–º –ø–µ—Ä–µ—à—ë–ª –∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º –æ—Ç–≤–µ—Ç–∞–º.

### –ú–µ—Ç—Ä–∏–∫–∏ –º—è–≥–∫–∏—Ö –æ—Ç–∫–∞–∑–æ–≤
- –¢–æ—á–Ω–∞—è –¥–æ–ª—è –Ω–µ –∏–∑–º–µ—Ä—è–ª–∞—Å—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ; –ø–æ tail-–ª–æ–≥—É –∏ –ø–µ—Ä–µ–ø–∏—Å–∫–µ ~30‚Äì40‚ÄØ% –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ ‚â§20‚ÄØ% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–∞–ª–∏—Å—å –∑–∞–≥–ª—É—à–∫–æ–π.

### –í—ã–≤–æ–¥—ã
- –û—á–µ—Ä–µ–¥—å AI –∏ –ª–∏–º–∏—Ç–µ—Ä —Å—Ç–∞–±–∏–ª—å–Ω—ã: `droppedSinceBoot=0`, `avgWaitMs=0`, `active` –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 1.
- –õ–∏–º–∏—Ç—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`kvConfig:null`), `AI_CONTROL_KV` –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.
- –î–µ–≥—Ä–∞–¥–∞—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞ —Ç–∞–π–º–∞—É—Ç–∞–º–∏ OpenAI Responses (`requestTimeoutMs=12000`) –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö; –¥–ª—è —Å–º—è–≥—á–µ–Ω–∏—è –Ω—É–∂–Ω—ã –ª–∏–±–æ –ø–æ–≤—ã—à–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `maxConcurrency=8`, `maxQueue=128`) —á–µ—Ä–µ–∑ KV, –ª–∏–±–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `requestTimeoutMs`/`retryMax`.
