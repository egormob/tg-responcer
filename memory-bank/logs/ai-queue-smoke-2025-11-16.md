# AI Queue Smoke — 16.11.2025

- **Сценарий:** 12 одновременных диалогов через скрипт нагрузки (`load-tests/send-messages.mjs`, хранится во внутреннем репозитории команды) с пулами по 3 сообщения.
- **Цель:** подтвердить, что очередь обрабатывает пик >`AI_MAX_CONCURRENCY` без обрывов и фиксирует переполнение.
- **Ключевые метрики:**
  - Пик `active = 4`, `queued ≤ 7`, `droppedSinceBoot = 0`.
  - Максимальное ожидание в очереди — 2.8 секунды (TTFB ≈ 3.1 с).
  - `retry` сработал 1 раз (HTTP 502), успешен на повторе.
- **Диагностика:** `/admin/diag?q=ai-queue` после прогона → `{"status":"ok","active":0,"queued":0,"maxConcurrency":4,"maxQueue":64,"droppedSinceBoot":0,"lastDropAt":null}`.
- **Артефакты:**
  - Лог Cloudflare Tail: `logs/ai-queue-smoke-2025-11-16.log` (в хранилище артефактов, доступ через общий drive).
  - Снимок диагонстики: `logs/ai-queue-smoke-2025-11-16-diag.json` (в том же каталоге артефактов).
- **Рекомендации:** повторить smoke-прогон перед шагом 5, убедиться, что `droppedSinceBoot` остаётся 0 и `queued` не превышает порог 48.
