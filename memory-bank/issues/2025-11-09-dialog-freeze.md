# Инцидент: заморозка диалога при 400 от transformPayload

**Таймстамп:** 2025-11-09T19:57:46Z (UTC).

## Наблюдения
- Пользователь не видит индикатор набора текста: бот перестаёт отправлять `sendTyping`, возникает ощущение зависания.
- В логах `apps/worker-main/http/router.ts` фиксируются ответы `400` от `transformPayload` при попытке собрать UTM-метки для события.
- Ошибку инициирует хендлер `apps/worker-main/features/utm-tracking/create-telegram-webhook-handler.ts`, который делает синхронный вызов `transformPayload` в критическом пути вебхука.
- Симптомы в логах: повторяющиеся записи `transformPayload → 400 Bad Request` и `UTM tracking failed, retry suppressed`, после чего обработка апдейта завершается без ответа пользователю.

## Гипотеза
- Синхронная запись UTM-данных в рамках основного обработчика Telegram блокирует ответ: при ошибке `transformPayload` брошенное исключение обрывает пайплайн, поэтому сообщение не отправляется и typing-индикатор отключается раньше времени.

## План восстановления
1. Вынести запись UTM-события из критического пути вебхука: обернуть в неблокирующую задачу/очередь, либо обрабатывать ошибки без прерывания основного потока.
2. Добавить автотесты для хендлера Telegram, проверяющие, что при провале UTM-обработки сообщение пользователю всё равно уходит.
3. Перепроверить ручным тестом: имитировать UTM-ошибку (`transformPayload` → 400), подтвердить, что ответ и typing-индикатор приходят без задержек.
4. Повторить регрессионный прогон после фикса: чек-лист `/admin/selftest`, тестовый диалог в Telegram, проверка логов UTM-наблюдения.

## Следующие действия
- Создать задачу на рефакторинг UTM-хендлера и запуск описанных тестов.
- Обновить мониторинг: добавить алерты на последовательные 400-ответы `transformPayload` без пользовательских сообщений.
