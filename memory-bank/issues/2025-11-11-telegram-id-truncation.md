# Инцидент: 400 Bad Request при усечении Telegram chat_id

**Таймстамп:** 2025-11-11T08:32:00Z (UTC).

## Симптомы
- Telegram API отвечает `400 Bad Request` на webhook-запросы.
- Пользователь не видит `typing`-индикатор: `sendChatAction` не отправляется после ошибки.
- В логах http-воркера фиксируются warnings о неверном `chat_id`.

## Затронутые модули
- `apps/worker-main/http/router.ts` — парсинг webhook и извлечение идентификаторов из входящего тела.
- `apps/worker-main/http/telegram-webhook.ts` — функция `toIdString`, преобразующая идентификаторы Telegram.
- `apps/worker-main/core/DialogEngine.ts` — использование `chat_id` при подготовке ответов.

## Контекст и предыдущие гипотезы
- Ранее рассматривали проблему потери сообщений как последствие деградации D1 и повторов в `saveUser`: см. [issues/d1-storage-degradation.md](d1-storage-degradation.md).

## Новая гипотеза
- Текущее преобразование `chat_id` усекло 64-битное значение до небезопасного для JavaScript числа, из-за чего при ответе в Telegram отправляется искажённый идентификатор. Для подтверждения нужно исключить `Number()` и парсить идентификаторы как BigInt-совместимые строки по всему пути.

## План восстановления
1. Внести big-int-safe парсер тела webhook: разобрать идентификаторы как строки и валидировать их длину до передачи дальше по пайплайну.
2. Добавить регрессионные тесты, покрывающие 64-битные и `-100...` chat_id для групповых чатов, чтобы гарантировать отсутствие усечения.
3. Обновить мониторинг: добавить метрику/алерт на повторяющиеся 400-ответы Telegram и отсутствие `sendChatAction` после webhook.

## Следующие действия
- Создать задачу на реализацию плана и синхронизировать её с дорожной картой.
- Проверить наличие связанных логов в `wrangler tail` и подготовить отчёт после развёртывания фикса.
