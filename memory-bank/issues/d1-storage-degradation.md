# Деградация D1 Storage при простое базы

## Контекст
- В периоды простоя D1 база `tg-responcer-db` кратковременно возвращает ошибки на `INSERT`/`UPDATE`. Сессии бота обрывались, потому что адаптер пробрасывал исключения наверх.
- Во время даунтайма сообщения и профили не сохраняются. После восстановления пользователи могут продолжить диалог, но история фрагментируется.

## Наблюдения
- Ошибки проявляются как `D1` `run()` rejection без дополнительных кодов. По логам, повторные попытки через ~100–300 мс обычно проходят.
- Сервис Telegram ожидает ответ от воркера < 10 секунд; отсутствие повторов приводило к разрыву чата.

## Решение
- `apps/worker-main/adapters/d1-storage/index.ts` теперь оборачивает `saveUser` и `appendMessage` в общий helper с экспоненциальным бэкоффом (3 попытки, 100→200→400 мс).
- Каждая неудача логируется как warning c деталями запроса; после исчерпания попыток записывается финальный warning, но исключение не выбрасывается.
- Исторические записи могут не попасть в D1 во время простоя, но бот продолжает отвечать, а журнал фиксирует деградацию.

## Рекомендации по мониторингу
- Настроить alert на частоту `[d1-storage] appendMessage exhausted retries` и `[d1-storage] saveUser exhausted retries` для фиксации деградаций.
- После восстановления D1 выполнить `wrangler d1 execute` с выборкой последних сообщений, чтобы убедиться в отсутствии длинных дыр в истории.

## Статус
- Фикс задеплоен через retry helper. Поведение покрыто unit-тестами (`apps/worker-main/adapters/d1-storage/__tests__/d1-storage.test.ts`).
- Мониторинг логов обновлён, ручное вмешательство не требуется.
