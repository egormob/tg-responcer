# Деградация D1 Storage при простое базы

## Контекст
- В периоды простоя D1 база `tg-responcer-db` кратковременно возвращает ошибки на `INSERT`/`UPDATE`. Сессии бота обрывались, потому что адаптер пробрасывал исключения наверх.
- Во время даунтайма сообщения и профили не сохраняются. После восстановления пользователи могут продолжить диалог, но история фрагментируется.

## Наблюдения
- Ошибки проявляются как `D1` `run()` rejection без дополнительных кодов. По логам, повторные попытки через ~100–300 мс обычно проходят.
- Сервис Telegram ожидает ответ от воркера < 10 секунд; отсутствие повторов приводило к разрыву чата.

## Решение
- `apps/worker-main/adapters/d1-storage/index.ts` теперь оборачивает `saveUser` и `appendMessage` в общий helper с экспоненциальным бэкоффом на 6 попыток (100 мс × 2ⁿ) и случайным джиттером.
- Каждая неудача логируется как warning с деталями запроса и следующей задержкой; после ≥3 попыток фиксируется отдельный warning об успешном завершении, что позволяет отслеживать деградации.
- Неретраябельные ошибки (валидация, схема) определяются по сообщению/коду и пробрасываются без повторов, но с явным предупреждением.
- Исторические записи могут не попасть в D1 во время простоя, но бот продолжает отвечать, а журнал фиксирует деградацию.

## Рекомендации по мониторингу
- Настроить alert на частоту `[d1-storage] appendMessage exhausted retries`, `[d1-storage] saveUser exhausted retries` и `[d1-storage] saveUser succeeded after retries` (или аналогичные для операций), чтобы фиксировать длительные очереди.
- После восстановления D1 выполнить `wrangler d1 execute` с выборкой последних сообщений, чтобы убедиться в отсутствии длинных дыр в истории.

## Статус
- Фикс задеплоен через retry helper. Поведение покрыто unit-тестами (`apps/worker-main/adapters/d1-storage/__tests__/d1-storage.test.ts`).
- Мониторинг логов обновлён, ручное вмешательство не требуется.
