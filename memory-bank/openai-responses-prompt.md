# OpenAI Responses: переход на `PromptID` и Responses-only

## Цель
Зафиксировать требования к вызову `/v1/responses` без `assistant_id`, описать проверки для адаптера `createOpenAIResponsesAdapter` и связанных модулей при переходе на `PromptID`.

## Основные требования
- **Model обязателен.** `env.OPENAI_MODEL` задаёт модель (например, `gpt-5`). Перед использованием строка обрезается (`trim()`) и валидируется на непустоту.
- **Опциональный Prompt.** Если используется опубликованный промпт, в запрос добавляется блок `prompt: { id: 'pmpt_…', variables }`. ID должен начинаться с `pmpt_`, переменные передаются в виде объекта и валидируются (JSON.parse + типы).
- **Состояние диалога.** Для продолжений вызовов передаём `previous_response_id`, который возвращает OpenAI. Значение хранится вместе с идентификатором пользователя, чтобы не смешивать контексты.
- **Парсинг ответа.** Используем `output_text` как основной текст. Если массив items содержит `message`/`function_call`, логируем их для диагностики.

## Чек-лист адаптера
1. **Валидация конфигурации.**
   - `OPENAI_MODEL` присутствует и не пуст.
   - Если задан `OPENAI_PROMPT_ID`, проходит проверку на префикс `pmpt_`.
   - `OPENAI_PROMPT_VARIABLES` (если есть) успешно парсится в JSON-объект.
2. **Формирование запроса.**
   - Тело содержит `model` и `input` (массив `[{role, content}]`).
   - При наличии промпта: блок `prompt` с `id` и `variables` (без `assistant_id`).
   - Заголовки включают `Authorization: Bearer <API_KEY>` и `Content-Type: application/json`.
3. **Обработка ответа.**
   - `response_id` и `output_text` логируются (без персональных данных).
   - Ошибки `AI_NON_2XX` пробрасываются в воркер с обрезанным сниппетом тела.
   - Поддерживаются ретраи (до 2 попыток) при сетевых сбоях и 5xx.
4. **Контекст продолжений.**
   - При успехе адаптер возвращает `{ text, responseId, previousResponseId }` и сохраняет `previousResponseId` в метаданные; при следующем запросе извлекает значение из контекста (если `metadata.responseId` присутствует).
   - При повторном вызове `previous_response_id` извлекается из сохранённого состояния пользователя (D1/KV).
5. **Тесты.**
   - Моки проверяют отсутствие `assistant_id` в теле.
   - Негативный тест на неверный `pmpt_`.
   - Проверка парсинга `output_text` и `items`.

## Диагностика и отладка
- `npm run test -- openai-adapter` — основная батарея.
- При ошибке `invalid prompt id` проверить, что промпт опубликован и ID скопирован полностью.
- Если OpenAI возвращает пустой `output_text`, логируем items и проверяем, не пришёл ли `function_call`.

## План миграции
1. Обновить `adapters/openai-responses` на новые переменные окружения.
2. Изменить `composition/compose.ts`, `index.ts` и тесты, чтобы они использовали `PromptConfig`.
3. Перепроверить `features/*`, которые читают `assistantId`, и заменить на новые поля или вынести под флаг.
4. Дополнить RoadMap/журнал статусом миграции (Майлстоун 4, шаг 1).

## Журнал
- 2025-11-07: Попытка открыть опубликованный промпт `pmpt_…` и извлечь обязательные переменные заблокирована отсутствием доступа к интерфейсу OpenAI Responses. В локальном репозитории нет ID промпта, модели или JSON-переменных; требуется команда с доступом к прод-окружению, чтобы зафиксировать данные. Без секретов `OPENAI_API_KEY`/`OPENAI_MODEL` self-test может использовать только noop-адаптер (см. [logs/admin-selftest-2025-11-07.log](../logs/admin-selftest-2025-11-07.log)).
