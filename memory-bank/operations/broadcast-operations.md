# Broadcast Operations Guide

## Контур и зависимости
- Единственный сценарий рассылки реализован через Telegram-команду `/broadcast` внутри воркера.
- Команда доступна только whitelisted администраторам из биндинга `ADMIN_TG_IDS`.
- Для отправки используется текущий Telegram-адаптер; дополнительные очереди, HTTP-роуты и фильтры не задействованы.

## Флаги и токены
- `TELEGRAM_BOT_TOKEN` — обязателен для обработки команд и отправки сообщений.
- `ADMIN_TG_IDS` — KV-namespace с whitelisted Telegram ID (`{"whitelist":["123","456"]}` или актуальный формат). Только эти ID могут завершить сценарий рассылки.
- `BROADCAST_ENABLED` (если присутствует) должен быть приведён к значению «1»/`true`, чтобы команда была активна.

## Сценарий `/broadcast`
1. Администратор отправляет `/broadcast` боту в личном чате.
2. Бот отвечает подсказкой «Введите текст рассылки» и ожидает следующее сообщение от того же администратора.
3. Полученный текст (обязательно непустой и ≤4096 символов) немедленно отправляется всем получателям минимальной модели рассылок.
4. После отправки бот подтверждает выполнение и сообщает количество чатов, куда ушло сообщение.

### Ограничения и проверки
- Длина сообщения — до 4096 символов. Более длинные тексты нужно разделять вручную.
- Глобальная скорость отправки: придерживаться безопасного порога ≤28 сообщений/сек (жёсткий предел ≈30/сек) и контролировать фактический темп рассылки.
- На каждый чат отправлять не более 1 сообщения в секунду; при необходимости растягивать рассылку по времени.
- Размер вложений (документы, медиа) — до 50 МБ; превышение приведёт к ошибке загрузки.
- Команда отклоняется для пользователей вне whitelist: бот отвечает `forbidden`/`access denied` и ничего не отправляет.
- Повторное использование `/broadcast` требует повторного ввода команды и текста; промежуточных очередей нет.

## Операционный чек-лист
1. **Подготовка окружения**
   - Убедиться, что `ADMIN_TG_IDS` содержит актуальные ID администраторов.
   - Выполнить `GET /admin/access` с валидным `x-admin-token`, проверить, что whitelisted ID перечислены в `whitelist`, а `health` показывает `status: "ok"` или объяснимые коды ошибок Telegram.
   - Проверить наличие и актуальность `TELEGRAM_BOT_TOKEN`.
   - (Если используется) выставить `BROADCAST_ENABLED=1` в KV.
2. **Проверка сценария**
   - От whitelisted аккаунта выполнить `/broadcast` → ввести короткий текст (например, «ping»). Подтвердить получение сообщения на тестовых чатах.
   - Попробовать команду с не-whitelisted аккаунта и убедиться, что бот корректно отказывает без отправки.
   - Протестировать граничные значения: пустой текст, текст из 4096 символов.
3. **Мониторинг**
   - Смотреть `wrangler tail` во время отправки; ошибки Telegram логируются тегом `[broadcast]`.
   - После рассылки записать событие в оперативный журнал (дата, администратор, количество получателей).

## Требования к журналированию
- Каждая рассылка фиксируется в журнале (например, `memory-bank/stable-builds.md` или отдельном operational log) с датой, администратором и кратким содержимым сообщения.
- При сбоях сохранить фрагменты логов `wrangler tail` и описать шаги восстановления.

## Редактирование и отзыв
- Мгновенная модель не поддерживает управление заданиями: при ошибке отправьте новое корректирующее сообщение.
- Если необходимо удалить сообщение, используйте стандартные ограничения Telegram (см. [`memory-bank/references/telegram-broadcast.md`](../references/telegram-broadcast.md)).

## Следующие шаги
- Оценить необходимость дополнительных защит (например, подтверждение перед отправкой) после накопления статистики использования.
