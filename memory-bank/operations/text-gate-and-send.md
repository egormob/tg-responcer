# Шлагбаум текста и подтверждение `/send`

**Назначение:** исключить случайную отправку разрозненных сообщений и гарантировать, что рассылка стартует только после явного согласия администратора.

## Стратегия
1. **Выбор аудитории.** После `/broadcast` бот ждёт `/everybody` или список chat_id/username. Пул формируется только из D1 (`messages`/`users`).
2. **Буферизация 1000 мс.** Как только аудитория подтверждена, активируется шлагбаум: все входящие текстовые обновления в течение 1000 мс объединяются в один пакет. Команда `/new_text` всегда перезапускает окно, `/cancel_broadcast` полностью отменяет сценарий.
3. **Сценарий A (один chunk).** Бот показывает предпросмотр, повторяет число получателей и ждёт `/send`. Команда `/send` подтверждает именно последний предпросмотр; отправка выполняется через `minimal-broadcast-service` с записью `broadcast:last`.
4. **Сценарий B (несколько chunk-ов).** Бот отвечает «Эти данные пришли несколькими сообщениями — текст отклонён…», логирует `text-gate_rejected` и требует нового текста. До `/new_text` или `/cancel_broadcast` все дополнительные сообщения игнорируются.
5. **Повторное меню.** После `/cancel_broadcast` бот мгновенно возвращает стандартное меню `/admin`, очищает pending-сессию и повторяет счётчик получателей при следующем запуске.

## Команды
- `/send` — единственная точка старта рассылки. Необработанные тексты не отправляются.
- `/new_text` — сбрасывает текст, повторно активирует 1000 мс окно, не меняет аудиторию.
- `/cancel_broadcast` — прекращает сценарий, очищает KV, показывает меню `/admin`. Алиас `/cancel` нормализуется в `/cancel_broadcast`.

## Дебаунс и тайминг
- Окно 1000 мс отсчитывается от первого текстового update после подсказки «Шаг 2». По истечении окна либо показывается предпросмотр (сценарий A), либо отправляется отказ (сценарий B).
- Лимит длины текста — 3970 видимых символов. Превышение блокирует сценарий до `/new_text` или `/cancel_broadcast`.
- При любых сетевых задержках шлагбаум гарантирует, что оператор увидит единый предпросмотр перед `/send`.

## Чек-лист ручных проверок
1. **Сценарий A.** `/broadcast` → `/everybody` → вставить текст одной порцией → убедиться, что бот повторил число получателей, предложил `/send` и отправил рассылку только после команды. Проверить tail: `text_gate=ok`, `broadcast recipients resolved`, `broadcast pool completed`.
2. **Сценарий B.** Повторить шаг, но отправить текст двумя сообщениями <1 с. Ожидание — ответ «текст отклонён…», отсутствие предпросмотра, наличие `text-gate_rejected` в tail.
3. **Команды восстановления.** После отклонения выполнить `/new_text` — бот снова ждёт текст и повторяет счётчик аудитории. `/cancel_broadcast` должно вернуть меню `/admin` и очистить pending ключи `broadcast:pending:*`.
4. **Tail / диаг.** Зафиксировать хвост `wrangler tail` или diag-отчёт. На 2025‑11‑30 подтверждение шлагбаума задокументировано в [`memory-bank/logs/diag-2025-11-30-broadcast-webhook.md`](../logs/diag-2025-11-30-broadcast-webhook.md#tail-успешного-webhook-и-broadcast).

Эта памятка прикладывается ко всем новым чатам и ссылкам UX, чтобы команда быстро находила требования к шлагбауму и подтверждению `/send`.
