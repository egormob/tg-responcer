# REPORT ‚Äî RoadMap 5.1 ¬´–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å UTM –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏¬ª (2025-11-20)

## –ö–æ–Ω—Ç–µ–∫—Å—Ç
- –°—Ç–µ–Ω–¥: —Ä–∞–±–æ—á–∏–π –≤–æ—Ä–∫–µ—Ä `tg-responcer` / –±–æ—Ç `@levelupme_bot`.
- –¶–µ–ª—å —à–∞–≥–∞ 5.1: –¥–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –ø–µ—Ä–≤—ã–π `/start <utm>` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç `utm_source` –≤ `users` –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏, –∞ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫—ç—à –∏ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å –¥–∏–ø–ª–∏–Ω–∫–æ–º `/start src_TEST-CAMPAIGN` —Å —Ä–µ–∞–ª—å–Ω–æ–≥–æ Telegram-–∞–∫–∫–∞—É–Ω—Ç–∞ (`chatId = fromId = 270641809`).

## –°—Ü–µ–Ω–∞—Ä–∏–π
1. –í–æ—Ä–∫–µ—Ä –∑–∞–¥–µ–ø–ª–æ–µ–Ω —Å —Ç–µ–∫—É—â–∏–º `wrangler.toml` (–±–∏–Ω–¥–∏–Ω–≥–∏ D1/KV –∞–∫—Ç–∏–≤–Ω—ã).
2. –ß–µ—Ä–µ–∑ Telegram –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `/start src_TEST-CAMPAIGN`.
3. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ payload.
4. –í –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –Ω–∞–±–ª—é–¥–∞–ª–∏—Å—å –æ–¥–∏–Ω–æ—á–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã OpenAI Responses ‚Üí fallback `–Ø –Ω–∞ —Å–µ–∫—É–Ω–¥—É –æ—Ç–≤–ª–µ–∫—Å—è... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â—ë —Ä–∞–∑ üîÅüí¨`; –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –æ—á–µ—Ä–µ–¥—å —á–µ—Ä–µ–∑ `/admin/diag?q=ai-queue`.

## –ù–∞–±–ª—é–¥–µ–Ω–∏—è
### 1. –ó–∞–ø–∏—Å—å `utm_source`
- `wrangler tail` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ü–µ–ø–æ—á–∫—É `[utm-tracking] incoming payload ‚Ä¶ hasStartPayload:true` ‚Üí `[telegram-webhook] normalized message ‚Ä¶ hasStartPayload:true` ‚Üí `[utm-tracking] saveUser result { userId:"270641809", utmSource:"src_TEST-CAMPAIGN", utmDegraded:false }`.
- –í Cloudflare D1 (—Ç–∞–±–ª–∏—Ü–∞ `users`) –∑–Ω–∞—á–µ–Ω–∏–µ `utm_source` –¥–ª—è `user_id = 270641809` —Ä–∞–≤–Ω–æ `src_TEST-CAMPAIGN`; —É—Ç–º-–¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ (`utmDegraded:true`) –Ω–µ –Ω–∞–±–ª—é–¥–∞–ª–æ—Å—å.

### 2. –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ payload
- –õ–æ–≥–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç `hasStartPayload:false` –≤ –æ–±–æ–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö (`utm-tracking`, `telegram-webhook`).
- –ü–æ–≤—Ç–æ—Ä–Ω—ã—Ö `[utm-tracking] saveUser result` –ø–æ `userId 270641809` –Ω–µ—Ç ‚Äî `knownUsersCache` —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.

### 3. AI –æ—á–µ—Ä–µ–¥—å –∏ fallback
- –í –º–æ–º–µ–Ω—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è `[ai][request]` ‚Üí `[ai][timeout]`/`[ai][retry] reason:"OpenAI Responses request timed out"` ‚Üí `[safe] done`; –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è `–Ø –Ω–∞ —Å–µ–∫—É–Ω–¥—É –æ—Ç–≤–ª–µ–∫—Å—è... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â—ë —Ä–∞–∑ üîÅüí¨`.
- –ß–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è `[ai][ok]` + `[ai][parsed] usedOutputText:false`, –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ –ø—Ä–æ–º–ø—Ç—É.
- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ `/admin/diag?q=ai-queue` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `status:"ok"`, `active:0`, `queued:0`, `maxConcurrency:4`, `maxQueue:64`, `requestTimeoutMs:18000`, `retryMax:3`, `droppedSinceBoot:0`. –ë–ª–æ–∫ `sources.*` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —á—Ç–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –∏–∑ `AI_CONTROL_KV`; `endpoints.activeBaseUrl = "https://api.openai.com/v1/responses"`, `backupBaseUrls = ["https://api.openai.com/v1/responses?cf_region=eu"]`, `failoverCounts` –æ—Å—Ç–∞—é—Ç—Å—è 0.

## –í—ã–≤–æ–¥—ã –ø–æ —à–∞–≥—É 5.1
- ‚úÖ `utm_source` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `users` –ø—Ä–∏ –ø–µ—Ä–≤–æ–º `/start src_TEST-CAMPAIGN` –∏ –Ω–µ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç.
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ payload –Ω–µ —Å–æ–∑–¥–∞—é—Ç `saveUser` ‚Äî –∫—ç—à `knownUsers` –¥–µ—Ä–∂–∏—Ç –∏—Å—Ö–æ–¥–Ω—É—é –º–µ—Ç–∫—É.
- ‚úÖ AI-–æ—á–µ—Ä–µ–¥—å Variant C –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ KV –∏ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç—ã OpenAI —Å –º—è–≥–∫–∏–º fallback –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
- ‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç—ã OpenAI –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫–∞–∫ `–Ø –Ω–∞ —Å–µ–∫—É–Ω–¥—É –æ—Ç–≤–ª–µ–∫—Å—è... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â—ë —Ä–∞–∑ üîÅüí¨`, –Ω–æ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ UTM.

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–∏—ë–º–∫–∏.** –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ UTM –∫–∞–∫: (–∞) –∑–∞–ø–∏—Å—å `utm_source` –≤ D1 –ø–æ—Å–ª–µ `/start`, (–±) –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö `saveUser`. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ª–æ–≥–∏ `utm-tracking`/`telegram-webhook` –ø–æ–ª–µ–º `message.user.utmSource` –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ payload.
2. **wrangler.toml.** –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ `[vars]`, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ ¬´–¥–æ–±–∞–≤–∏–º –±–∏–Ω–¥–∏–Ω–≥–∏ –ø–æ–∑–∂–µ¬ª (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –±–∏–Ω–¥–∏–Ω–≥–∏ —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Å–µ–∫—Ü–∏—è—Ö `d1_databases`/`kv_namespaces`).
3. **–î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏ RoadMap.** –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–∏–º –ø—É–Ω–∫—Ç–∞–º –±–ª–æ–∫–∞ 5 (—ç–∫—Å–ø–æ—Ä—Ç/–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ UTM –≤ CSV, –ª–∏–º–∏—Ç—ã –∏ —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥) –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∏–∫—Å–æ–≤ –ø–æ UTM-—Ç—Ä–µ–∫–µ—Ä—É.
