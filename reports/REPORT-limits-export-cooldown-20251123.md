# REPORT — Limits & Export Cooldown Diagnostic (ПРОВЕРКА 6.1)

- **Дата:** 2025-11-23
- **Артефакты:** `logs/limits-6-1-tail.json`, скриншоты Telegram (админ и пользователь)
- **Цель:** подтвердить, что отключение `LIMITS_ENABLED` снимает ограничения только с пользовательских диалогов и не влияет на `rawRateLimit` админского `/export`, а также проверить 60-секундный кулдаун экспорта.

## 1. Пользовательские сообщения при LIMITS_ENABLED=0
- Отправлены подряд несколько сообщений из пользовательского чата.
- Логи (`[telegram-webhook]`, `[ai][ok]`) показывают `limit: "ok"`, `status: 200`, нет `429`.
- Диалоговый контур отвечает, `aiRequestId` фиксируется для каждого сообщения.
- **Вывод:** пользовательские лимиты отключаются, UX стабильный.

## 2. Экспорт `/export` под админом (rawRateLimit)
- Первый `/export` внутри окна прошёл успешно: `rowCount: 1849`, `utmSources: ["src_DIAG", "src_TEST-GREETING", "stress_test"]`, `status: 200`, бот отправил CSV в Telegram (`"sending export to telegram"`).
- Повторные `/export` в течение 60 секунд отсекаются `rawRateLimit`: `status: 429`, лог `"admin export cooldown active"`, воркер отправляет уведомление «Экспорт формируется, подождите 60 секунд».
- **Вывод:** админский лимитер остаётся жёстким, даже если `LIMITS_ENABLED=0`.

## 3. CSV и кулдаун
- CSV сформирован корректно, `rowCount: 1849`, HTTP-ответ 200.
- TTL кулдауна 60 секунд — повторные попытки в логах получают 429 с русскоязычным уведомлением.
- Ошибок `expiration_ttl of 30` не обнаружено, значит TTL ≥ 60 применяется корректно.

## 4. Логи
- `logs/limits-6-1-tail.json` содержит полный след: успешный экспорт → повторные 429 → пользовательские сообщения без ограничений.
- Повторные записи `"admin export cooldown active"` демонстрируют активный кулдаун.

## 5. Вывод
- **ПРОВЕРКА 6.1** завершена: пользовательские лимиты отключаются по флагу, админский `rawRateLimit` и кулдаун экспорта продолжают работать.
- Дополнительно зафиксировано, что текст уведомления берётся из `EXPORT_COOLDOWN_NOTICE`, что обеспечивает единый UX.

## 6. Рекомендации
1. Добавить краткую таблицу «Поведение лимитов при разных значениях `LIMITS_ENABLED`» в операционные памятки.
2. Зафиксировать минимальный TTL кулдауна (≥60 секунд) как обязательное значение, чтобы избежать регрессии к 30 секундам.
